---
title: "多层线性模型"
subtitle: "高级定量分析"
author: "宋骁 彭璟 吴迪雅 姜昱竹 宋虹玉"
date: "2019/06/17"
output:
  xaringan::moon_reader:
    css: [default, GBBB.css]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      
---
# Let's Start!
``````{r Intro, echo=F, fig.cap=" ", out.width = '55%',fig.align='center'}
knitr::include_graphics("https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1559987331910&di=a089e476c808440db9f7a356b7096f51&imgtype=0&src=http%3A%2F%2Fpic4.zhimg.com%2Fv2-ea8103bf18ea17c1320dfceadf9f580f_b.gif")

```

---
class: center, middle
# 数据与变量
``````{r 2, echo=F, fig.cap=" ", out.width = '55%',fig.cap="姜昱竹 10171170149",fig.align='center'}
knitr::include_graphics("zhu.jpg")

```
---

## 数据介绍
.mid[
+ 1988 年**中国居民收入调查**(CHIP)数据

+ 由中国社会科学院经济研究所主持。

+ 分阶段抽样：

  + 先从30 个省级行政单位中抽选出10 个省份。
  
  + 再从这10个省份的434个城市中抽选出55个城市。
  
  + 在55个城市中，共调查9009 户家庭。


+ 调查问卷收集了每一户中所有家庭成员的资料。在删除缺失数据和不完整观测个案之后，总共得到15862条居民个体的观测数据。
]
---

## 研究问题
.large[
+ 研究经济改革的成功与个人收入决定因素之间的关系

+ 教育回报率

+ 对Mincer模型的改进
]
---

## 变量
.mid[
+ 因变量：
  + 收入的自然对数值

+ 个人变量：
  + <font color=#FF0000>教育年限</font>
  + 工作年限(即工龄)
  + 党员身份的虚拟变量(1=党员, 0=非党员)
  + 性别的虚拟变量(1=女性, 0=男性)

+ 城市层面变量：
  + 1985年和1988年之间各城市工业总产值(GPVI)的变化
  
$${Z_j} = \log (GPV{I_{1988}}/GPV{I_{1985}})$$
]
---
## 因变量

```{r 512, echo=F, out.width = '75%',fig.align='center',message=F,warning=F,fig.cap="收入对数的密度直方图",fig.asp = 0.75}

library(haven)
library(tidyverse)
library(lattice)
require(stats)
chip <- read_dta("F:/Mysite/Mysite/static/slides/mlepre/chip88.dta")
attach(chip)
histogram(logearn,equal.widths = TRUE, nint = 70, xlab = "收入对数",type = "density",ylab = '密度')
```


---
class: center, middle

# 模 型

```{r 3, echo=F, fig.cap="吴迪雅 10161170121", out.width = '35%',fig.align='center'}
knitr::include_graphics("diya.jpg")
```

---


## 零模型(ANOVA)
.mid[
 + 层1： 
 
$${y_{ij}} = {\beta _{0j}} + {\varepsilon _{ij}}$$
 + 层2：
 
$${\beta _{0j}} = {\gamma _{00}} + {\mu _{0j}}$$
 + 组合模型
 
$${y_{ij}} = {\gamma _{00}} + {\mu _{0j}} + {\varepsilon _{ij}}$$

其中,
${\beta _{0j}}$是第j个层2单位的平均值,

$\gamma_{00}$表示样本整体中因变量的总平均值(grand mean) ,

${\mu _{0j}}$是与第j个层2单位相联系的随机效应
]
---
## 随机截距模型
.mid[
+ 层1：

$${{\rm{y}}_{ij}} = {\beta _{0j}} + {\beta _{1j}}({x_{ij}} - {{\bar x}_{ \cdot j}}) + {\varepsilon _{ij}}$$



+ 层2：

$${\beta _{0j}} = {\gamma _{00}} + {\mu _{0j}}$$

+ 组合模型

$${{\rm{y}}_{ij}} = \underbrace {{\beta _{1j}}({x_{ij}} - {{\bar x}_{ \cdot j}})}_{fixed{\rm{ }}\ effect} + \underbrace {{\gamma _{00}} + {\mu _{0j}} + {\varepsilon _{ij}}}_{random{\rm{ }}\ effect}$$

其中,
$\gamma_{00}$表示层2 所有单位的回归截距的平均值。

$\gamma_{10}$表示层2 所有单位的回归斜率的平均值。
]
---
## 随机截距模型

```{r sur2, echo=F, fig.cap="<font color=#FF0000>各回归直线平行，斜率相同，截距随层2随机变化</font>", out.width = '70%',fig.align='center'}
knitr::include_graphics("random.jpg")
```



---

## 随机系数模型
.mid[
+ 层1：

$${{\rm{y}}_{ij}} = {\beta _{0j}} + {\beta _{1j}}({x_{ij}} - {{\bar x}_{ \cdot j}}) + {\varepsilon _{ij}}$$

+ 层2：

$${\beta _{0j}} = {\gamma _{00}} + {\mu _{0j}}$$
$${\beta _{1j}} = {\gamma _{10}} + {\mu _{1j}}$$

组合模型：
$${{\rm{y}}_{ij}} = \underbrace {{\gamma _{00}} + {\gamma _{10}}({x_{ij}} - {{\bar x}_{ \cdot j}})}_{fixed{\rm{ }}\ effect} + \underbrace {{\mu _{0j}} + {\mu _{1j}}({x_{ij}} - {{\bar x}_{ \cdot j}}) + {\varepsilon _{ij}}}_{random{\rm{ }}\ effect}$$


]



---
## 随机系数模型

```{r sur1, echo=F, fig.cap="<font color=#FF0000>各回归直线的截距和斜率均随层2随机变化</font>", out.width = '70%',fig.align='center'}
knitr::include_graphics("random2.jpg")
```


---
### 完全模型(引入层2解释变量)

#### 将截距和斜率作为结果的回归模型

 + 层1： 
 
$${y_{ij}} = {\beta _{0j}} + {\beta _{1j}}{x_{ij}} + {\varepsilon _{ij}}$$
 + 层2：
 
$${\beta _{0j}} = {\gamma _{00}} + {\gamma _{01}}{Z_j} + {\mu _{0j}}$$

$${\beta _{1j}} = {\gamma _{10}} + {\gamma _{11}}{Z_j} + {\mu _{1j}}$$

+ 代入得到：

$${y_{ij}} = \underbrace {{\gamma _{00}} + {\gamma _{01}}{Z_j} + {\gamma _{10}}{x_{ij}} + {\gamma _{11}}{Z_j}{x_{ij}}}_{fixed{\rm{ }}\ effect} + \underbrace {{\mu _{0j}} + {\mu _{1j}}{x_{ij}} + {\varepsilon _{ij}}}_{random{\rm{ }}\ effect}$$

${Z_j}$
为层2解释变量，为第j个城市的工业总产值(GPVI)的变化

---
class: center, middle

# Stata 命令
```{r 4, echo=F, fig.cap="宋骁 10161170106", out.width = '35%',fig.align='center'}
knitr::include_graphics("xsong.jpg")

```
---
## 命令示例

+ **geo**为层2标识变量  

+ **z**为层2解释变量。1985年和1988年之间各城市工业总产值(GPVI)的变化，<font color=#FF0000> **z**越大，则该城市经济发展越快</font> 。

```sql

/*零模型*/
mixed LogY || geo: , variance

/*随机截距模型*/
mixed LogY x1 || geo: , variance

/*随机系数模型*/
mixed LogY x1 || geo: x1, variance

/*完全模型*/
mixed LogY x1 z x1#z || geo: x1, variance


```
---
## 对中

```sql
/*组均值对中*/
sort geo

*by geo: egen edumean = mean(edu) 

g cen_edu = edu - edumean

```
---

## 零模型运行结果

```python 
*. mixed logearn || geo: , variance

Performing EM optimization: 

Performing gradient-based optimization: 

Iteration 0:   log likelihood = -7978.9487  
Iteration 1:   log likelihood = -7978.9487  (backed up)

Computing standard errors:

*Mixed-effects ML regression                     Number of obs     =     15,862
*Group variable: geo                             Number of groups  =         55

                                                Obs per group:
                                                              min =         80
                                                              avg =      288.4
                                                              max =      1,096

                                                Wald chi2(0)      =          .
Log likelihood = -7978.9487                     Prob > chi2       =          .

```

---

```python 



------------------------------------------------------------------------------
     logearn |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
*      _cons |   7.421528   .0254612   291.48   0.000     7.371625     7.47143
------------------------------------------------------------------------------

------------------------------------------------------------------------------
  Random-effects Parameters  |   Estimate   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
geo: Identity                |
*                 var(_cons) |   .0348887   .0068122      .0237949    .0511547
-----------------------------+------------------------------------------------
               var(Residual) |   .1579178   .0017763      .1544744     .161438
------------------------------------------------------------------------------
LR test vs. linear model: chibar2(01) = 2377.51       Prob >= chibar2 = 0.0000

```
---
## 随机截距模型

```sql
*. mixed logearn cen_edu || geo: , variance

Performing EM optimization: 

Performing gradient-based optimization: 

Iteration 0:   log likelihood = -7838.2144  
Iteration 1:   log likelihood = -7838.2144  

Computing standard errors:

Mixed-effects ML regression                     Number of obs     =     15,862
Group variable: geo                             Number of groups  =         55

                                                Obs per group:
                                                              min =         80
                                                              avg =      288.4
                                                              max =      1,096

                                                Wald chi2(1)      =     283.99
Log likelihood = -7838.2144                     Prob > chi2       =     0.0000

```
---

```sql
------------------------------------------------------------------------------
     logearn |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
*    cen_edu |   .0172395    .001023    16.85   0.000     .0152345    .0192446
*      _cons |   7.421519   .0254621   291.47   0.000     7.371614    7.471424
------------------------------------------------------------------------------

------------------------------------------------------------------------------
  Random-effects Parameters  |   Estimate   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
geo: Identity                |
*                 var(_cons) |   .0349047   .0068124      .0238096    .0511699
-----------------------------+------------------------------------------------
               var(Residual) |   .1551307    .001745       .151748    .1585888
------------------------------------------------------------------------------
LR test vs. linear model: chibar2(01) = 2420.35       Prob >= chibar2 = 0.0000


```
---
## 随机系数模型

```sql
*. mixed logearn cen_edu || geo: cen_edu, variance

Performing EM optimization: 

Performing gradient-based optimization: 

Iteration 0:   log likelihood = -7823.6964  
Iteration 1:   log likelihood = -7823.6964  

Computing standard errors:

Mixed-effects ML regression                     Number of obs     =     15,862
Group variable: geo                             Number of groups  =         55

                                                Obs per group:
                                                              min =         80
                                                              avg =      288.4
                                                              max =      1,096

                                                Wald chi2(1)      =     106.60
Log likelihood = -7823.6964                     Prob > chi2       =     0.0000

```
---
```sql
------------------------------------------------------------------------------
     logearn |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
*    cen_edu |    .016245   .0015734    10.32   0.000     .0131612    .0193288
       _cons |   7.421517   .0254624   291.47   0.000     7.371612    7.471422
------------------------------------------------------------------------------

------------------------------------------------------------------------------
  Random-effects Parameters  |   Estimate   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
geo: Independent             |
*               var(cen_edu) |   .0000667   .0000246      .0000323    .0001376
                  var(_cons) |   .0349087   .0068126      .0238133     .051174
-----------------------------+------------------------------------------------
               var(Residual) |   .1544599   .0017402      .1510866    .1579085
------------------------------------------------------------------------------
LR test vs. linear model: chi2(2) = 2449.38               Prob > chi2 = 0.0000

Note: LR test is conservative and provided only for reference.

```
---
## 完全模型

```sql
*. mixed logearn cen_edu exp cpc sex gross_d c.cen_edu#c.gross_d || geo:exp cpc sex cen_
> edu, variance

Mixed-effects ML regression                     Number of obs     =     15,862
Group variable: geo                             Number of groups  =         55

                                                Obs per group:
                                                              min =         80
                                                              avg =      288.4
                                                              max =      1,096

                                                Wald chi2(6)      =    2628.79
Log likelihood = -5403.8032                     Prob > chi2       =     0.0000

```
---

## 完全模型：固定系数部分

```sql

-------------------------------------------------------------------------------------
            logearn |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
--------------------+----------------------------------------------------------------
*           cen_edu |   .0379732    .003369    11.27   0.000       .03137    .0445764
                exp |   .0174423   .0004242    41.12   0.000     .0166108    .0182737
                cpc |    .082668   .0087801     9.42   0.000     .0654592    .0998767
                sex |  -.0982807   .0056184   -17.49   0.000    -.1092925    -.087269
            gross_d |    .457095   .1014866     4.50   0.000     .2581849    .6560051
                    |
c.cen_edu#c.gross_d |  -.0120191   .0066043    -1.82   0.069    -.0249633    .0009251
                    |
              _cons |   6.887719   .0529885   129.99   0.000     6.783864    6.991575
-------------------------------------------------------------------------------------

```
---
## 完全模型：随机系数部分

```python

------------------------------------------------------------------------------
  Random-effects Parameters  |   Estimate   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
geo: Independent             |
                    var(exp) |   3.89e-06   1.55e-06      1.78e-06    8.48e-06
                    var(cpc) |   .0010555   .0006423      .0003203    .0034787
*               var(cen_edu) |   .0000611   .0000206      .0000316    .0001184
                  var(_cons) |   .0266634   .0053698      .0179676    .0395677
-----------------------------+------------------------------------------------
               var(Residual) |   .1137761   .0012856      .1112841    .1163239
------------------------------------------------------------------------------
LR test vs. linear model: chi2(4) = 2538.60               Prob > chi2 = 0.0000

Note: LR test is conservative and provided only for reference.

```
---
## 组内相关系数
### (intraclass correlation, ICC)
```python
. estat icc

Conditional intraclass correlation

------------------------------------------------------------------------------
                       Level |        ICC   Std. Err.     [95% Conf. Interval]
-----------------------------+------------------------------------------------
*                        geo |   .1898569    .031039      .1362892    .2581855
------------------------------------------------------------------------------
Note: ICC is conditional on zero values of random-effects covariates.
```
+ 收入对数的19.0%的方差可以被城市因素所解释。

---
## 结论
.large[
+ 改革开放时期中国的地区异质性会影响中国的人力资本回报率。

+ 交互项系数为负。经济发展水平越高的地区，教育回报率越低。
]


---
class: center, middle

# 谢谢!
``````{r end, echo=F, fig.cap=" ",out.width = '60%',fig.align='center'}
knitr::include_graphics("https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1559921618412&di=f118b115bf4ab9ab74be09f366906204&imgtype=0&src=http%3A%2F%2Fb-ssl.duitang.com%2Fuploads%2Fitem%2F201809%2F12%2F20180912072220_qivjj.thumb.700_0.gif")
```

---
class: center, middle
# 幻灯片制作
```{r 99, echo=F, fig.cap="彭璟 10171170121", out.width = '30%',fig.align='center'}
knitr::include_graphics("penjin.jpg")

```
---
class: center, middle
# 数据清理
```{r 100, echo=F, fig.cap="宋虹玉 10171170131", out.width = '40%',fig.align='center'}
knitr::include_graphics("songhongyu.jpg")
```



