---
title: "R"
author: " "
date: " "
output:
  bookdown::html_document2:
    toc: true
    theme: united
slug: ranalysis
---

# 聚类分析

## k-means聚类

[k-means in R](https://uc-r.github.io/kmeans_clustering)

```{r delta,message = F, comment = NA,warning = F,include = T,fig.align='center',out.width ='100%',fig.asp=0.7}
#葡萄酒数据
#install.packages("rattle")
data(wine, package="rattle")
knitr::kable(head(wine))

library(cluster)
set.seed(1234)
fit.pam <- pam(wine[-1], k=3, stand=T)#3个质心
knitr::kable(fit.pam$medoids) #查看质心

library(fMultivar)
set.seed(1234)
df <- rnorm2d(1000, rho=0.9) #2元正态分布
df <- as.data.frame(df)
plot(df, main="Bivariate Normal Distribution with rho=0.9")

library(ggplot2)
library(cluster)
fit <- pam(df, k=2)
df$clustering <- factor(fit$clustering)#输出聚类结果变量
ggplot(data=df, aes(x=V1, y=V2, color=clustering, shape=clustering)) +
geom_point() + ggtitle("Clustering of Bivariate Normal Data")

require(graphics)
# a 2-dimensional example
x <- rbind(matrix(rnorm(100, sd = 0.3), ncol = 2),
           matrix(rnorm(100, mean = 1, sd = 0.3), ncol = 2))
colnames(x) <- c("x", "y")
(cl <- kmeans(x, 2))
plot(x, col = cl$cluster)
points(cl$centers, col = 1:2, pch = 8, cex = 2)

```

## 系统聚类

```{r a,message = F, comment = NA,warning = F,include = T,fig.align='center',out.width ='95%',fig.asp=0.7}

#班级数据
library(cluster)
Rclass=read.csv("E:/R_codes/others/Rdclass.csv",header=T)
Rclass1=Rclass[,-c(1,6,7,8)]
rownames(Rclass1)=Rclass$Name
gower_dist<-daisy(Rclass1,metric = "gower")#分类变量的聚类
#summary(gower_dist)
h <- hclust(gower_dist)
plot(h,main = '系统聚类图')
rect.hclust(h, k=7, border = "red")
(cn <- cutree(h, k = 7))
```

# 词云图

```{r b,message = F, comment = NA,warning = F,include = T,cache=T,fig.align='center',out.width ='100%',fig.asp=0.6}
#install.packages('wordcloud2')
#install.packages('jiebaR')
library(wordcloud2)
library(jiebaR)
text <- readLines("E:/R_codes/others/Rkws.csv",encoding = "UTF-8")
text <- text[-1] 
freq <- freq(text)
index <- order(-freq[,2]) 
order2 <- freq[index, ]
wordcloud2(freq,size = 1, color = "random-light")
#wordcloud2(freq,size = 1, color = "random-light",shape='cardioid')
#wordcloud2(freq,size = 1, color = "random-light",shape='diamond')
```

# 主成分分析

```{r c,message = F, comment = NA,warning = F,include = T,cache=T,fig.align='center',out.width ='90%',fig.asp=0.8}
#数据:USJudgeRatings
knitr::kable(head(USJudgeRatings))
library(psych)
fa.parallel(USJudgeRatings[,-1], fa="pc", n.iter=100,
show.legend=F, main="碎石图")
pc <- principal(USJudgeRatings[,-1], nfactors=1, rotate="varimax", score=T) #方差极大旋转
pc

USJudgeRatings$score <- pc$scores
knitr::kable(head(USJudgeRatings$score))

```

# 市场人群细分

+ CHAID算法
  + 卡方自动交互检测器

+ Latent Class

+ Canonical Correlation (典型相关分析)
  + 可以做多组变量(连续、离散）的分析
  + 之后做聚类
  + 出来之后的维度类似于因子，思路和因子分析相差不大
  + 权重和loading
  + 保存对象得分，得出连续因子
  
+ 最后做系统聚类，最小聚类数，最大聚类数。最好使用`ward`方法

+ 1000样本量尽量分4-5群

+ 说服自己、说服客服

+ 最后做判别分析

# 计量经济学：因果推断模型


## Regression Discontinuity Design

```{r cars2,message = F, comment = NA,warning = F,include = T}

library(tidyverse)
#install.packages("rdd")
library(magrittr)
library(MASS)
library(rdd)
set.seed(1)
n <- 10 ^ 3
mu <- matrix(c(0, 0))
rho <- 0.5
sigma1 <- 0.5
sigma2 <- 2
Sigma <- matrix(c(sigma1 ^ 2,
rho * sigma1 * sigma2,
rho * sigma1 * sigma2,
sigma2 ^ 2),
c(2, 2))
simulatedXandC <- mvrnorm(n = n, mu = mu, Sigma = Sigma)
simulatedError <- rnorm(n = n)
simulatedZ <- round(runif(n))
group <- round(runif(n))
df <- data.frame(X = simulatedXandC[, 1],
C = simulatedXandC[, 2],
error = simulatedError)
library(tidyverse)
df %<>%
mutate(Y = 10 + 1 * X + 5 * C + error)
fit <- lm(Y ~ X, data = df)
summary(fit)
fit <- lm(Y ~ X + C, data = df)
summary(fit)

df <- data.frame(X = simulatedXandC[, 1],
C = simulatedXandC[, 2],
T = (simulatedXandC[, 1] > 0),
error = simulatedError)
df %<>%
mutate(Y = 10 + X ^ 3 + 5 * T + 1 * C + error)
fit <- RDestimate(Y ~ X, data = df)
summary(fit)
library(ggplot2)
rdplot <- ggplot(data = df, aes(x = X, y = Y, color = (X > 0))) +
geom_point() +
geom_smooth(method = lm,
se = FALSE)
rdplot
```


## Difference-in-Differences

```{r cars3,message = F, comment = NA,warning = F,include = T}
df <- data.frame(time = 10 * round(runif(n), 1) - 5,
treatment = group,
error = simulatedError)
library(tidyverse)
df %<>%
mutate(Y = 1 - time + 5 * treatment + 7 * (time >= 0) * treatment + error)
fit <- lm(Y ~ time + treatment + I((time >= 0) * treatment), data = df)
summary(fit)
dfMean <- df %>%
group_by(time, treatment) %>%
summarise(Y = mean(Y))
ggplot(data = df, aes(x = time, y = Y, color = factor(treatment + 2 * (time >= 0)))) +
geom_point() +
geom_smooth(method = lm,
se = FALSE) +
theme(legend.position = "none") +
scale_color_manual(values = c("#F05253", "#2A73CC", "#F05253", "#2A73CC"))
```

## Fixed Effects Regression

```{r cars4,message = F, comment = NA,warning = F,include = T}
df <- data.frame(X = simulatedXandC[, 1],
C = round(pmin(2, pmax(-2, simulatedXandC[, 2]))),
error = simulatedError)
df %<>%
mutate(Y = 10 + 1 * X + 5 * C + error)
fit <- lm(Y ~ X, data = df)
summary(fit)
fit <- lm(Y ~ X + factor(C), data = df)
summary(fit)
```

## Instrumental Variables

```{r cars5,message = F, comment = NA,warning = F,include = T}
df <- data.frame(Z = simulatedZ,
X = simulatedXandC[, 1] + simulatedZ,
C = simulatedXandC[, 2],
error = simulatedError)
df %<>%
mutate(Y = 10 + 1.0 * X - 2 * C + error)

#Naive regression produces biased estimates
fit <- lm(Y ~ X, data = df)
summary(fit, vcov = sandwich)

#IV recovers the underlying model
fit <- ivreg(Y ~ X | Z, data = df)
summary(fit, vcov = sandwich, df = Inf, diagnostics = TRUE)

```












