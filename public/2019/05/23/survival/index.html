<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Hugo 0.55.5" />


<title>生存分析云笔记 - Xiao Song </title>
<meta property="og:title" content="生存分析云笔记 - Xiao Song ">


  <link href='../../../../favicon.ico' rel='icon' type='image/x-icon'/>



  








<link href='//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css' rel='stylesheet' type='text/css' />



<link rel="stylesheet" href="../../../../css/fonts.css" media="all">
<link rel="stylesheet" href="../../../../css/main.css" media="all">



  </head>
  <body>
    <div class="wrapper">
      <header class="header">
        <nav class="nav">
  <a href="../../../../" class="nav-logo">
    <img src="../../../../images/logo.png"
         width="50"
         height="50"
         alt="Logo">
  </a>

  <ul class="nav-links">
    
    <li><a href="../../../../">Home</a></li>
    
    <li><a href="../../../../englishresume/">Resume</a></li>
    
    <li><a href="../../../../chnresume/">Chinese Resume</a></li>
    
    <li><a href="https://github.com/ECSTA7Y">GitHub</a></li>
    
    <li><a href="../../../../reward/">Reward</a></li>
    
  </ul>
</nav>

      </header>

<link rel="stylesheet">

<main class="content" role="main">

  <article class="article">

    <h1 class="article-title">生存分析云笔记</h1>

    
    <span class="article-date">2019-05-23</span>
    

    <div class="article-content">
      


<p>本文系复旦大学人口学系<a href="http://www.ssdpp.fudan.edu.cn/portal/1e2812ee711c4175a3304c7dbc7071e0/70VhqG.html">张震</a>老师和华东师范大学人口研究所<a href="">李强</a>老师的数据分析课程笔记。</p>
<p>一个R生存分析应用的介绍网页<a href="https://rviews.rstudio.com/2017/09/25/survival-analysis-with-r/">Survival Analysis with R</a></p>
<p>两篇重要的中文文献：</p>
<p>李强, 张震. (2009). 生存分析中时间变量的选择[J]. 中国人口科学(6), 88-95.</p>
<p>李强, 徐刚, 陈丽梅.(2019) 生存分析的应用误区[J]. 中国人口科学(01):101-112.</p>
<hr />
<div id="-" class="section level2">
<h2>第一讲: 基本概念</h2>
<ul>
<li>社会调查只能观察到状态。人口学关心从一个状态到另一个状态转移的风险。试想每一种状态是一个格子，格子内部是人口频数。人口学能通过数频数的方式估计状态转移的风险。<strong>在一个状态内待的时间和风险有着密切的关系</strong>。</li>
</ul>
<p><span class="math inline">\(T\)</span>为随机变量，上帝也不知道</p>
<p>生存函数：<span class="math inline">\(S(t) = P(T &gt; t)\)</span>。是存活概率也是存活百分比。</p>
<p>失效函数(Failure Function)：<span class="math inline">\(F(t)\)</span>,<span class="math inline">\(S(t) = 1 - F(t)\)</span>, <span class="math inline">\(F(t)\)</span>是T的累积分布函数。</p>
<p><span class="math inline">\(f(t) = \frac{{dF(t)}}{{dt}}\)</span>，即<span class="math inline">\(S(t)\)</span>的斜率。等价于生存时间的概率密度函数(直方图)。是无条件的风险。</p>
<p>风险函数: <span class="math display">\[h(t) = \mathop {\lim }\limits_{\Delta t \to 0} \frac{{P(t \le T &lt; t + \Delta t|T \ge t)}}{{\Delta t}},0 &lt; h(t) &lt;  + \infty \]</span></p>
<p><span class="math inline">\(h(t)\)</span>不是密度也不是概率。</p>
<ul>
<li>censor(删截): 知道事件发生，但不知道事件何时发生。事件观测期内无法观测。</li>
<li><p>truncate(截平): 只有在给定观测期内的个体才会被观测到的状况。样本选择问题。生存函数对应于某种条件概率。</p></li>
<li><p>censor涉及到事件，truncate涉及到暴露量。</p></li>
<li><p>能活到预期寿命者总是62%</p></li>
</ul>
<hr />
</div>
<div id="-mle" class="section level2">
<h2>第二讲: 最大似然估计(MLE)</h2>
<p>Cox回归避开了模型分布假定的问题。</p>
<ul>
<li><p>假定数据独立同分布。</p>
<p>似然函数：</p></li>
</ul>
<p><span class="math display">\[{\rm{L}}(\lambda ){\rm{ = }}\prod\limits_{i = 1}^\pi  {P(T = t)}  = \prod {f({t_i})}\]</span><br />
<span class="math inline">\(\delta\)</span>是积分小区间</p>
<p><span class="math display">\[P(T = t) \approx 2\delta f(t)\]</span></p>
<ul>
<li>发生风险率(Occurrence-exposure rate) <span class="math display">\[\widehat \lambda  = \frac{1}{{\bar t }} = \frac{n}{{\sum\limits_{}^{} {{t_i}} }}\]</span> <span class="math inline">\(\sum\limits_{}^{} {{t_i}}\)</span>是历险人年数。<span class="math inline">\(n\)</span>是事件发生数。<br />
<span class="math inline">\(\lambda\)</span>是个概率估计。</li>
</ul>
<div id="censored" class="section level3">
<h3>删截(Censored)样本的似然函数</h3>
<ul>
<li>完全样本的似然函数是在该时点t的密度函数<span class="math inline">\(f({t_i})\)</span>。右删截数据是生存函数<span class="math inline">\(S({C_r})\)</span>。左删截数据为累计分布函数<span class="math inline">\(1 - S({C_l})\)</span>。区间删截为在该时段内的发生概率<span class="math inline">\(S(L) - S(R)\)</span>。</li>
</ul>
<p>右删截： <span class="math display">\[P({t_i} &gt; 40) = S(40)\]</span></p>
<ul>
<li>40岁删截</li>
</ul>
<p><span class="math display">\[L(\lambda ) = \prod\limits_{observed} {f({t_i})}  \cdot \prod\limits_{censored} {S(40)}\]</span></p>
<p>Assume the first <span class="math inline">\(d\)</span> individuals died, <span class="math inline">\((n-d)\)</span> ware alive at 40:</p>
<p><span class="math display">\[\hat \lambda  = \frac{d}{{\sum {{t_i} - (n - d) \cdot 40} }}\]</span></p>
<p>分子为事件发生数。</p>
<p>人口学、医学中最多的情况是left-truncated &amp; right-cencored(LT-RC)数据。</p>
<p>非参数模型Aalen’s additive regression model可以替代Cox模型。R的<code>survival</code>包的<code>aareg</code>函数可以进行拟合。</p>
<hr />
</div>
</div>
<div id="-" class="section level2">
<h2>第三讲: 生存分析估计</h2>
<p>R生存分析介绍：<a href="http://www.openintro.org/stat/surv.php">survival analysis in R</a></p>
<pre class="r"><code>&gt; library(survival)
&gt; library(haven) 
&gt; library(ggplot2)
&gt; library(dplyr)
&gt; library(ggfortify)</code></pre>
<ul>
<li>数据介绍：<br />
<code>los1</code>:时间变量<br />
<code>cen_r</code>:事件是否发生,被收养成功</li>
</ul>
<pre class="r"><code>&gt; table(cwg$event)</code></pre>
<pre><code>
  0   1 
978 300 </code></pre>
<pre class="r"><code>&gt; # Kaplan Meier Survival Curve
&gt; km &lt;- with(cwg, Surv(los1, event == 1))
&gt; head(km,100) #删截后面有+号</code></pre>
<pre><code>  [1]  4.30000000+  6.00000000  21.00000000+  0.03333333  10.63333333 
  [6]  4.43333333+  6.86666667+  4.46666667+  2.40000000+  9.00000000 
 [11]  6.10000000+ 10.73333333  11.46666667   8.60000000  28.53333333+
 [16] 17.96666667+ 21.16666667+ 12.16666667   4.70000000+  0.16666667+
 [21] 25.76666667+  2.73333333+  0.03333333  11.76666667+  2.26666667+
 [26]  2.26666667+ 23.36666667+  2.40000000+ 11.80000000+  2.40000000+
 [31] 13.90000000+ 11.30000000+  0.73333333+ 14.86666667+ 17.36666667+
 [36] 20.53333333+  5.96666667+  5.73333333+  6.03333333+ 24.36666667+
 [41] 24.36666667+  6.23333333  18.90000000+ 25.96666667+  5.23333333+
 [46]  4.43333333+  4.20000000   4.20000000  17.83333333+ 11.86666667 
 [51] 11.86666667  17.80000000+ 20.56666667+  6.00000000+  8.76666667+
 [56] 24.33333333+ 30.70000000+  2.63333333  11.23333333+ 21.96666667+
 [61] 20.60000000+ 20.60000000+ 10.56666667  10.56666667  28.70000000+
 [66] 31.63333333+ 23.16666667+  8.50000000+ 24.43333333+  7.13333333+
 [71] 18.03333333+ 12.16666667+ 12.16666667+  1.03333333+  1.53333333+
 [76] 26.16666667+  6.93333333+  5.26666667+  9.30000000   0.23333333 
 [81] 13.50000000+  1.13333333   1.13333333   8.30000000+ 19.53333333+
 [86] 18.36666667+ 18.36666667+ 22.43333333+ 22.66666667+  2.83333333+
 [91]  2.83333333+ 10.80000000+ 11.13333333   1.46666667+  4.73333333+
 [96] 12.83333333+ 12.83333333+  0.93333333+  1.23333333+  1.23333333+</code></pre>
<pre class="r"><code>&gt; km_fit &lt;- survfit(km ~ 1, data=cwg)
&gt; km_fit #生存分析概要</code></pre>
<pre><code>Call: survfit(formula = km ~ 1, data = cwg)

      n  events  median 0.95LCL 0.95UCL 
   1278     300      NA      NA      NA </code></pre>
<pre class="r"><code>&gt; summary(km_fit, times = c(0.2*(1:35))) #这个东西和生命表等价</code></pre>
<pre><code>Call: survfit(formula = km ~ 1, data = cwg)

 time n.risk n.event survival std.err lower 95% CI upper 95% CI
  0.2   1237      24    0.981 0.00382        0.974        0.989
  0.4   1226       5    0.977 0.00420        0.969        0.985
  0.6   1219       0    0.977 0.00420        0.969        0.985
  0.8   1215       1    0.976 0.00427        0.968        0.985
  1.0   1211       3    0.974 0.00448        0.965        0.983
  1.2   1199       3    0.972 0.00468        0.962        0.981
  1.4   1187       1    0.971 0.00475        0.961        0.980
  1.6   1183       2    0.969 0.00488        0.960        0.979
  1.8   1175       1    0.968 0.00494        0.959        0.978
  2.0   1163       4    0.965 0.00520        0.955        0.975
  2.2   1160       1    0.964 0.00526        0.954        0.974
  2.4   1141       3    0.962 0.00544        0.951        0.972
  2.6   1134       4    0.958 0.00568        0.947        0.969
  2.8   1105      11    0.949 0.00628        0.937        0.961
  3.0   1098       0    0.949 0.00628        0.937        0.961
  3.2   1083       7    0.943 0.00665        0.930        0.956
  3.4   1062      10    0.934 0.00714        0.920        0.948
  3.6   1055       3    0.931 0.00728        0.917        0.946
  3.8   1046       3    0.929 0.00742        0.914        0.943
  4.0   1041       4    0.925 0.00760        0.910        0.940
  4.2   1031       7    0.919 0.00791        0.904        0.935
  4.4   1019       3    0.916 0.00804        0.901        0.932
  4.6   1008       4    0.913 0.00821        0.897        0.929
  4.8    991       8    0.905 0.00853        0.889        0.922
  5.0    977       7    0.899 0.00881        0.882        0.916
  5.2    974       3    0.896 0.00893        0.879        0.914
  5.4    961       7    0.890 0.00919        0.872        0.908
  5.6    956       2    0.888 0.00926        0.870        0.906
  5.8    953       1    0.887 0.00930        0.869        0.905
  6.0    944       4    0.883 0.00945        0.865        0.902
  6.2    934       2    0.881 0.00952        0.863        0.900
  6.4    926       6    0.876 0.00974        0.857        0.895
  6.6    920       2    0.874 0.00981        0.855        0.893
  6.8    917       2    0.872 0.00988        0.853        0.891
  7.0    915       0    0.872 0.00988        0.853        0.891</code></pre>
<pre class="r"><code>&gt; autoplot(km_fit) #ggplot2风格KM图</code></pre>
<p><img src="../../../../post/survival_files/figure-html/b-1.png" width="100%" style="display: block; margin: auto;" /></p>
<pre class="r"><code>&gt; km_trt_fit &lt;- survfit(km ~ female, data=cwg)#分性别KM估计
&gt; autoplot(km_trt_fit) #图中+号可能是&quot;打结&quot; ties?</code></pre>
<p><img src="../../../../post/survival_files/figure-html/b-2.png" width="100%" style="display: block; margin: auto;" /></p>
</div>
<div id="cox" class="section level2">
<h2>Cox比例风险模型</h2>
<p><span class="math display">\[\ln {h_i}(t) = \ln {h_0}(t) + {\beta _1}{X_1} + {\beta _2}{X_2} +  \cdot  \cdot  \cdot  + {\beta _p}{X_p}\]</span></p>
</div>

    </div>
  </article>

  
<section id="comments">
  <div id="disqus_thread"></div>
  <script>
  var disqus_config = function () {
  
  };
  (function() {
    var inIFrame = function() {
      var iframe = true;
      try { iframe = window.self !== window.top; } catch (e) {}
      return iframe;
    };
    if (inIFrame()) return;
    var d = document, s = d.createElement('script');
    s.src = '//Xiao Song.disqus.com/embed.js'; s.async = true;
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>



</main>

      <footer class="footer">
        <ul class="footer-links">
          
        </ul>
      </footer>

    </div>
    



<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>



<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/r.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>



    
<script src="../../../../js/math-code.js"></script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>


    
  </body>
</html>

