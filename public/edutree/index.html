<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Hugo 0.55.5" />


<title>初中生学习成绩的影响因素: 基于分类与回归树的分析 - Xiao Song </title>
<meta property="og:title" content="初中生学习成绩的影响因素: 基于分类与回归树的分析 - Xiao Song ">


  <link href='../favicon.ico' rel='icon' type='image/x-icon'/>



  








<link href='//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css' rel='stylesheet' type='text/css' />



<link rel="stylesheet" href="../css/fonts.css" media="all">
<link rel="stylesheet" href="../css/main.css" media="all">



  </head>
  <body>
    <div class="wrapper">
      <header class="header">
        <nav class="nav">
  <a href="../" class="nav-logo">
    <img src="../images/logo.png"
         width="50"
         height="50"
         alt="Logo">
  </a>

  <ul class="nav-links">
    
    <li><a href="../">Home</a></li>
    
    <li><a href="../englishresume/">Resume</a></li>
    
    <li><a href="../chnresume/">Chinese Resume</a></li>
    
    <li><a href="https://github.com/ECSTA7Y">GitHub</a></li>
    
    <li><a href="../reward/">Reward</a></li>
    
  </ul>
</nav>

      </header>

<link rel="stylesheet">

<main class="content" role="main">

  <article class="article">

    <h1 class="article-title">初中生学习成绩的影响因素: 基于分类与回归树的分析</h1>

    
    <span class="article-date">2019-05-08</span>
    

    <div class="article-content">
      


<div class="section level2">
<h2>数据</h2>
<p>本文采用<a href="https://ceps.ruc.edu.cn/">中国教育追踪调查</a> (China Education Panel Survey, CEPS)2013-2014学年基线数据。 采用PPS抽样方法，以人口平均受教育水平和人口比例为分层变量并通过两阶段分层抽样从从全国随机抽取了28个县级单位作为调查点。具体而言，CEPS在每个入样县（区）所辖地理范围内分别抽取4所初中学校。并在每所入样学校中分别抽取4个班级，包括2个七年级班和2个九年级班。</p>
</div>
<div class="section level2">
<h2>模型与算法</h2>
<p>CART算法全称为分类与回归树（Classification and Regression Trees）。它可以处理分类与回归算法，以及生存分析因变量。作为一种非参数的机器学习方法，CART决策树无需对数据的分布做任何假定。CART算法划分数据的依据是变量的取值顺序，因此它对异常值不敏感。最后，通过交叉验证（Cross Validation）的方法求得预测误差。 回归树模型可表示为： <span class="math display">\[f(x) = \sum\limits_{m = 1}^M {{c_m}I(x \in {R_m})} \]</span></p>
<p>其中，<span class="math inline">\(x\)</span>是一系列输入特征（自变量），<span class="math inline">\({R_1},{R_2},...,{R_m}\)</span>是输入空间被划分的M个区域。 是区域<span class="math inline">\({R_m}\)</span>对应的最优值。<span class="math inline">\(I\)</span>代表的是指示函数（indicator function），当输入变量<span class="math inline">\(x\)</span>属于区域 <span class="math inline">\({R_m}\)</span>时，输出为1，否则输出为0。 CART算法选择基尼系数进行属性划分。CART算法可以运用于分类和回归问题中。</p>
<p>为了防止过拟合问题(Over-fitted),需要对过于复杂的树模型进行剪枝。这也是训练模型的重要过程。通过改善模型的复杂度参数(Complexity Parameter, CP)。在CART算法中，复杂度参数定义如下：</p>
<p><span class="math display">\[{{\rm{C}}_\alpha }(T) = C(T) + \alpha \left| T \right|\]</span></p>
<p>其中，<span class="math inline">\(T\)</span>为任意子树。<span class="math inline">\(C(T)\)</span>为对训练数据的预测误差（如基尼指数）， <span class="math inline">\(\left| T \right|\)</span>为子树的叶结点个数，<span class="math inline">\(\alpha \ge 0\)</span>为参数，<span class="math inline">\({{\rm{C}}_\alpha }(T)\)</span>是参数为<span class="math inline">\(\alpha\)</span>时的子树<span class="math inline">\(T\)</span>的整体损失。参数<span class="math inline">\(\alpha\)</span>测量了模型的复杂度。</p>
</div>
<div class="section level2">
<h2>变量</h2>
<p>本研究依据以往教育学和社会学文献，选取了50个自变量进行预测。为了降低测量误差，本研究在变量选取的过程中遵循了以下两个原则：1.尽可能挑选“客观的”变量。2.尽可能挑选直观上对学习成绩有重要影响的变量。</p>
<div class="section level3">
<h3>因变量</h3>
<p>本研究的因变量是被调查学生上一次期中考试的成绩。包括数学成绩、语文成绩、英语成绩。我们将同时对总成绩进行分析。</p>
<p>为了讨论学习成绩的门槛效应，我们将数学成绩是否位于所有学生的前25%(是=1，否=0)单独划分为一个分类变量建立分类树。下图展示了标准化总成绩的密度直方图估计。箱线图展示了编号为1-30的学校的数学原始成绩差异。我们可以发现，标准化总成绩基本上呈现了正态分布。不同学校间的数学成绩差异十分显著。</p>
</div>
<div class="section level3">
<h3>自变量</h3>
<p>下面展示了自变量以及自变量在模型中的编码：</p>
<p>家庭变量：每星期零用钱(money)、上兴趣班费用总计(clfee)、监督孩子的作业(qianzi)、花在孩子身上的时间(lifetm)、孩子交流方言(dial)、父母交流方言(chidia)、家长教育期望(eduyexp)、对孩子未来的信心(futcfd)、孩子户口类型(huko)、家长教育程度(eduy)、家长政治面貌(dangy)、住房是否生产经营用(houspro)。</p>
<p>个人变量：性别(sex)、是否独生子女(onechi)、父亲教育水平(faedu)、母亲教育水平(maedu)、爸爸经常酗酒(drunk)、父母经常吵架(qurel)、父母之间关系很好(relation)、有独立书桌(desk)、家里有电脑和网络(net)、家庭交流方言(dialect)、父母督促学习天数(chkhmwk chkcouse)、父母教育期望(eduexp)。</p>
<p>学校变量：学校性质(schtype)、教室数量(schcsrm)、学校电脑数(comno)、图书数量(bknum)、生均财政拨款(buget)、持有教师资格证人数(eduqua)、打架斗殴(fight)、破坏公物(brkpb)、吸烟(smok)、饮酒(drink)、高级教师年收入(teainc)。</p>
<p>班级变量：教师总课时(classtm)、 备课时间(clpre)、批改作业时间(revitm)、班主任教授本班科目(subject)、认识多少家长(know)、是否有抽烟喝酒的学生(drsmok)、与学生交流时间(commhr)。</p>
<p><img src="../post/edutree_files/figure-html/add%20-1.png" width="100%" style="display: block; margin: auto;" /></p>
<p>为了直观地描述不同学校与学习成绩的差异，下面展示了以学校为分组变量，原始数学成绩为因变量的箱线图。</p>
<p><img src="../post/edutree_files/figure-html/a%20-1.png" width="100%" style="display: block; margin: auto;" /></p>
</div>
</div>
<div class="section level2">
<h2>分析结果</h2>
<div class="section level3">
<h3>回归树</h3>
<p>首先我们将展示总成绩的回归结果。由于七年级和九年级学生考试总分的不同。我们将九年级子样本单独进行分析，并采用10折交叉验证计算模型的验证误差。</p>
<pre class="r"><code>&gt; cont &lt;- rpart.control(minsplit=5,maxcompete=100,xval=10,maxdepth=30,cp=0.01)
&gt; tree &lt;- rpart(sdtotal ~ schids + sex + onechi +  maedu +  faedu + drunk + 
+ qurel + relation +  desk + net + dialect + chkhmwk + chkcouse + 
+ classtm +  clpre + revitm + subject + know + drsmok + commhr + 
+ schtype + schcsrm +  comno +  bknum + buget +  eduqua + fight + 
+ brkpb + smok +  drink +  teainc + money + clfee + qianzi + lifetm +  
+ dial +  chidia +  futcfd +  huko + eduy +  dangy +  houspro ,data = 
+ subset(ceps,grade9 == 1),weights = sweight,method = &quot;anova&quot;,parms = 
+ list(split=&quot;gini&quot;),control=cont,na.action = na.omit)</code></pre>
<pre class="r"><code>tree$cptable #复杂度参数表</code></pre>
<pre><code>          CP nsplit rel error    xerror         xstd
1 0.07468185      0 1.0000000 1.0007711 0.0005637024
2 0.03717668      1 0.9253181 0.9268397 0.0005272599
3 0.01820999      2 0.8881415 0.9054125 0.0005358907
4 0.01328867      3 0.8699315 0.8884106 0.0005364790
5 0.01308371      4 0.8566428 0.8757729 0.0005394897
6 0.01281814      5 0.8435591 0.8746542 0.0005381943
7 0.01000000      6 0.8307410 0.8558705 0.0005325595</code></pre>
<pre class="r"><code>rpart.plot(tree)</code></pre>
<div class="figure" style="text-align: center"><span id="fig:sfff"></span>
<img src="../post/edutree_files/figure-html/sfff-1.png" alt="总成绩的回归树" width="100%" />
<p class="caption">
Figure 1: 总成绩的回归树
</p>
</div>
<p>下面展示的是数学原始成绩是否位于前25%的分类决策树。首先，我们在备选的约50个自变量中纳入学校哑变量。仅考虑家庭、个体、班级因素对学生学习成绩的影响。通过划分训练集和测试集的方式计算模型的预测错误率。检验模型的泛化能力。</p>
<p><a href="https://www.jianshu.com/p/08c28c5c55a7">R语言表格</a></p>
<pre class="r"><code>&gt; set.seed(1212323) #设置随机数种子
&gt; sampled &lt;- sample(1:nrow(ceps),nrow(ceps)*0.3,replace=FALSE) #抽取30%样本作为验证集
&gt; test &lt;- ceps[sampled,] #测试集
&gt; train &lt;- ceps[-sampled,] #训练集
&gt; 
&gt; cont &lt;- rpart.control(minsplit=5,maxcompete=100,xval=10,maxdepth=30,cp=0.01) #设置参数
&gt; 
&gt; cltree3 &lt;- rpart(matgreat ~  schids + sex + onechi +  maedu +  faedu + drunk + 
+ qurel + relation + desk + net + dialect + chkhmwk + chkcouse + 
+ classtm +  clpre + revitm + subject + know + drsmok + commhr + 
+ schtype + schcsrm + comno +  bknum + buget + eduqua + fight + 
+ brkpb + smok +  drink +  teainc + money + clfee + qianzi + lifetm +  
+ dial +  chidia +  futcfd +  huko + eduy +  dangy +  houspro ,data = 
+ subset(train,grade9 == 1),weights = sweight,method = &quot;class&quot;,parms = 
+ list(split=&quot;gini&quot;),control=cont,na.action = na.omit,model=T) #决策树
&gt; #knitr::kable(printcp(cltree3),caption=&quot;复杂度参数表&quot;,digits =4)
&gt; rpart.plot(cltree3)</code></pre>
<p><img src="../post/edutree_files/figure-html/c%20-1.png" width="100%" style="display: block; margin: auto;" /></p>
<pre class="r"><code>&gt; test &lt;- na.omit(test) #删除缺失值
&gt; y.pr &lt;- predict(cltree3,test,type=&quot;prob&quot;) #预测测试集概率
&gt; 
&gt; pr &lt;- y.pr[,2] 
&gt; test &lt;- cbind(test,pr)
&gt; modelroc &lt;- roc(test$matgreat,test$pr)
&gt; plot(modelroc,xlab =&#39;伪正类率&#39;,ylab=&#39;真正类率&#39;) #ROC 曲线</code></pre>
<p><img src="../post/edutree_files/figure-html/c%20-2.png" width="100%" style="display: block; margin: auto;" /></p>
<pre class="r"><code>&gt; test$yhat &lt;- ifelse(test$pr &gt;0.5,&#39;1&#39;,&#39;0&#39;) #大于0.5设置为&quot;是&quot;
&gt; attach(test)
&gt; tab &lt;- table(yhat,matgreat) 
&gt; names(dimnames(tab))&lt;-c(&quot;预测值&quot;,&quot;真实值&quot;)
&gt; treeerror &lt;- (sum(tab)-sum(diag(tab)))/sum(tab)
&gt; tab</code></pre>
<pre><code>      真实值
预测值   0   1
     0 875 183
     1 138  85</code></pre>
<pre class="r"><code>&gt; treeerror #测试集错误率</code></pre>
<pre><code>[1] 0.2505855</code></pre>
<pre class="r"><code>&gt; cont &lt;- rpart.control(minsplit=5,maxcompete=100,xval=10,maxdepth=30,cp=0.014) #设置参数
&gt; 
&gt; cltree3 &lt;- rpart(matgreat ~  schids + sex + onechi +  maedu +  faedu + drunk + 
+ qurel + relation + desk + net + dialect + chkhmwk + chkcouse + 
+ classtm +  clpre + revitm + subject + know + drsmok + commhr + 
+ schtype + schcsrm + comno + bknum + buget + eduqua + fight + 
+ brkpb + smok +  drink +  teainc + money + clfee + qianzi + lifetm +  
+ dial +  chidia +  futcfd + huko + eduy + dangy +  houspro ,data = 
+ subset(train,grade9 == 1),weights = sweight,method = &quot;class&quot;,parms = 
+ list(split=&quot;gini&quot;),control=cont,na.action = na.omit) #决策树
&gt; 
&gt; #knitr::kable(printcp(cltree3),caption=&quot;复杂度参数表&quot;,digits =4)
&gt; cltree3$variable.importance #各个变量的重要性程度</code></pre>
<pre><code>     smok     bknum   classtm    eduqua     buget   subject    revitm 
92336.104 87082.851 72098.477 42822.536 37990.537 28371.716 26624.118 
   schids      know     fight     brkpb     comno    commhr     clpre 
25602.670 25452.345 23572.820 22293.765 21516.771 18454.934 16719.141 
   chidia   schcsrm    teainc   chkhmwk 
 9999.162  9588.660  2283.551  2032.974 </code></pre>
<pre class="r"><code>&gt; rpart.plot(cltree3)</code></pre>
<p><img src="../post/edutree_files/figure-html/d%20-1.png" width="100%" style="display: block; margin: auto;" /></p>
<pre class="r"><code>&gt; test &lt;- na.omit(test) #删除缺失值
&gt; y.pr &lt;- predict(cltree3,test,type=&quot;prob&quot;) #预测测试集概率
&gt; 
&gt; pr &lt;- y.pr[,2] 
&gt; test &lt;- cbind(test,pr)
&gt; modelroc &lt;- roc(test$matgreat,test$pr)
&gt; auc(modelroc) #计算AUC值</code></pre>
<pre><code>Area under the curve: 0.6951</code></pre>
<pre class="r"><code>&gt; plot(modelroc,xlab =&#39;伪正类率&#39;,ylab=&#39;真正类率&#39;) #ROC 曲线</code></pre>
<p><img src="../post/edutree_files/figure-html/d%20-2.png" width="100%" style="display: block; margin: auto;" /></p>
<pre class="r"><code>&gt; test$yhat &lt;- ifelse(test$pr &gt;0.5,&#39;1&#39;,&#39;0&#39;) #大于0.5设置为&quot;是&quot;
&gt; attach(test)
&gt; tab &lt;- table(yhat,matgreat) 
&gt; treeerror &lt;- (sum(tab)-sum(diag(tab)))/sum(tab)
&gt; names(dimnames(tab))&lt;-c(&quot;预测值&quot;,&quot;真实值&quot;) #矩阵小标题
&gt; tab #混淆矩阵，行为测试集预测值，列为测试集观测值</code></pre>
<pre><code>      真实值
预测值   0   1
     0 875 183
     1 138  85</code></pre>
<pre class="r"><code>&gt; treeerror #测试集错误率</code></pre>
<pre><code>[1] 0.2505855</code></pre>
<p>可以发现，对因变量分类有显著贡献的变量有学校哑变量、对孩子未来的信心、上兴趣班费用总计、与学生交流时间。可见学校层面的特征对数学成绩的影响非常强。</p>
<p>在初次拟合分类树之后，我们对分类树进行剪枝。通过第一棵分类树的结果，我们选取预测误差(即表中的xerror通过交叉验证获得)最小的CP值带入到下一个模型中，最终的验证集错误率在25%左右。</p>
</div>
<div class="section level3">
<h3>随机森林</h3>
<pre class="r"><code>&gt; train$matgreat &lt;- as.factor(train$matgreat)
&gt; train &lt;- na.omit(train)
&gt; train &lt;- filter(train, is.na(matgreat)==F)
&gt; 
&gt; ratree &lt;- randomForest(matgreat ~ schids + sex + onechi +  maedu +  faedu + drunk + qurel + relation + desk + net + dialect + chkhmwk + chkcouse + classtm +  clpre + revitm + subject + know + drsmok + commhr + schtype + schcsrm + comno + bknum + buget + eduqua + fight + brkpb + smok + drink + teainc + money + clfee + qianzi + lifetm +  dial +  chidia +  futcfd + huko + eduy + dangy +  houspro  ,data = subset(train,grade9 == 1),importance=T,proximity=T,mtry=16)
&gt; 
&gt; #ratree
&gt; #summary(ratree)
&gt; #MDSplot(ratree,matgreat,palette=NULL)
&gt; 
&gt; importance(ratree, type=1, scale=T) #计算模型变量的重要性</code></pre>
<pre><code>         MeanDecreaseAccuracy
schids             15.8079765
sex                -1.1436013
onechi              4.9067360
maedu              -1.9834895
faedu               3.7691257
drunk              -1.5504492
qurel              -0.1781571
relation           -0.1456353
desk                3.2705643
net                 4.5125379
dialect             4.7907267
chkhmwk            -1.0885660
chkcouse            1.5032324
classtm            19.4422332
clpre              14.1047252
revitm             10.5477621
subject            12.4271037
know                8.0812284
drsmok             13.3536686
commhr             12.3985947
schtype             4.1675248
schcsrm            14.8336130
comno              15.9875348
bknum              20.7425997
buget              18.8042500
eduqua             18.0370464
fight               6.5585319
brkpb               7.5392667
smok               15.0468939
drink               1.8399370
teainc             27.6905792
money               4.9882468
clfee               7.4162946
qianzi              6.2598867
lifetm             -1.2848707
dial                9.9690394
chidia              7.3747625
futcfd             17.6419549
huko                4.9797779
eduy               -0.0509333
dangy               1.4430383
houspro             7.6867660</code></pre>
</div>
</div>

    </div>
  </article>

  
<section id="comments">
  <div id="disqus_thread"></div>
  <script>
  var disqus_config = function () {
  
  };
  (function() {
    var inIFrame = function() {
      var iframe = true;
      try { iframe = window.self !== window.top; } catch (e) {}
      return iframe;
    };
    if (inIFrame()) return;
    var d = document, s = d.createElement('script');
    s.src = '//Xiao Song.disqus.com/embed.js'; s.async = true;
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>



</main>

      <footer class="footer">
        <ul class="footer-links">
          
        </ul>
      </footer>

    </div>
    



<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>



<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/r.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>



    
<script src="../js/math-code.js"></script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>


    
  </body>
</html>

