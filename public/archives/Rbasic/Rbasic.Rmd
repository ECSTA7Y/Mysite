---
title: "R 基础操作" 
subtitle: ' '
author: '宋骁'
date: ' '
output:
  bookdown::html_document2:
    toc: true
    theme: united
slug: basicr
## bookdown themes:https://bookdown.org/yihui/bookdown/theming.html
---

本文收集了我在学习R过程中觉得重要的知识点。

# 基本对象

模式强制转换：字符串：`as.character()`,整数：`as.integer()`,向量：`as.vector()`, 数据框：`as.data.frame()`

## 数组和矩阵

```{r ,message = F, comment = NA,warning = F}
library(dplyr)
library(ggplot2)
library(magrittr)
library(dplyr)
library(titanic)

mar<-c(652,1537,598,242,36,46,38,21,218,327,106,67)
caff.marital<-matrix(mar,nrow=3,byrow=T) #byrow=T通过行来填充
caff.marital
#nrow和ncol中的一个被明确给出，则R会计算相应的另一个，从而使得矩阵中的数值与输入的值数目相匹配
x <- array(1:20, dim=c(4,5))  
x

h <- c(1:24)
Z <- array(h, dim=c(3,4,2)) #创建3X4X2的数组
Z
Z[,,2]#索引
vec <- as.vector(Z)
vec

# 数组命名
vector1 <- c(5,9,3)
vector2 <- c(10,11,12,13,14,15)
column.names <- c("COL1","COL2","COL3")
row.names <- c("ROW1","ROW2","ROW3")
matrix.names <- c("Matrix1","Matrix2")

result <- array(c(vector1,vector2),dim = c(3,3,2),dimnames = list(row.names,column.names,
   matrix.names))
result
result[,,'Matrix2'] #索引
```

## 列表

+ 列表（list）是一个以对象的有序集合构成的对象。列表中包含的对象又称为它的分量（components）。
分量可以是不同的模式或类型，如一个列表可以同时包括数值向量，逻辑向量，矩阵，复向量，字符数组，函数等等。

# 循环
`for`循环
```{r,message = F, comment = NA,warning = F}
pp <- c("Peter", "Piper", "picked", "a", "peck", "of", "pickled", "peppers")
for(i in seq_along(pp)) print(pp[i])
```


# `apply()`族函数

[Tutorial on the R Apply Family](https://www.datacamp.com/community/tutorials/r-tutorial-apply-family?utm_source=adwords_ppc&utm_campaignid=1565261270&utm_adgroupid=67750485268&utm_device=c&utm_keyword=&utm_matchtype=b&utm_network=g&utm_adpostion=1t1&utm_creative=332661264365&utm_targetid=aud-392016246653:dsa-473406586995&utm_loc_interest_ms=&utm_loc_physical_ms=9032008&gclid=CjwKCAjw6vvoBRBtEiwAZq-T1VINBuWR5b5Pe3QeGmfaBBSQ_57nvMN6p7H1AVs3iBpQXgEx480XuxoC_0UQAvD_BwE)

包括`sapply()`, `lapply()`, 和 `tapply()`

`lapply()`默认返回值是列表

`aggregate()`类似于`dplyr::group_by`

```{r,message = F, comment = NA,warning = F}
sapply(iris, class)
```





# `dplyr`处理缺失值


```{r,message = F, comment = NA,warning = F}
stocks <- tibble(
year = c(2015, NA, 2015, 2015, NA, 2016, 2016),
qtr = c( 1, 2, NA, NA, 2, NA, 4),
return = c(1.88, 0.44, 0.35, 0.66, 0.92, 0.17, 3.40)
)
knitr::kable(stocks,caption = '数据概要')
```

缺失值重编码成其他值：

+ 任务，将`qtr`等于`NA`的行的`year`变量重编码为`9999`

+ `dplyr::recode`无法给出条件

```{r ,message = F, comment = NA,warning = F}
stocks %>% mutate(year= ifelse(is.na(qtr),9999,year))

stocks %>% mutate(year=case_when(
  is.na(qtr) ~ 9999,
  is.na(qtr)==F ~ year,
))

stocks %>% mutate(year=replace(year,is.na(qtr),9999))
```

其他值重编码成缺失值：

+ 

+ 使用`na_if`。但是无法给出条件。

```{r ,message = F, comment = NA,warning = F}
stocks %>% mutate(return=ifelse(year==2016,NA,return))

stocks %>% mutate(return=replace(return,year==2016,NA))

stocks %>% mutate(return=na_if(return,year==2016))

stocks %>% mutate(year=na_if(year,2016))

stocks %>% mutate(return=na_if(year==2016,return))

```

# 数据合并

+ `cbind()`把矩阵横向合并成一个大矩阵（列方式），而`rbind()`是纵向合并（行方式）。

+ `dplyr`的`join`方法

```{r ,message = F, comment = NA,warning = F,error=T,cache=T}

myData <- data.frame(
    nation=rep(c('USA','Japan','Libya'),3),
    subregion=rep(c('north','south','middle'),each=3),
    Awesomeness=rnorm(9)
    )
myData

countryData <- data.frame(
    nation=c('USA','Japan','Libya','Belarus'),
    NumberOfSquid=c(rpois(4,10))
    )
countryData

myData %>% full_join(countryData,copy=T)
myData %>% left_join(countryData,copy=T)

library(plyr)
join(myData, countryData, by='nation', type='left', match='all')

```

# 使用`devtools`本地安装R包

以`REmap`包为例,从[github](https://github.com/)上下载压缩包后，使用`install_local`安装。

```{r,eval=F}
library(devtools)
install_github('lchiffon/REmap') #可以试试，但基本不好使
install_local("C:/Users/lenovo/Desktop/REmap-master.zip") #设置正确的本地路径
```

# [`magrittr`](https://magrittr.tidyverse.org/)管道操作符

[张丹的文章](https://mp.weixin.qq.com/s/wD2tK04qGJ8Qvb-sD0Nhcg)

`%T>%`

`%$%`

```{r ,message = F, comment = NA,warning = F,error=T}
rnorm(100) %>%
matrix(ncol = 2) %T>%
plot() %>%
str()

myData %$%
  table(nation,subregion)

mar <- 
myData %$%
  table(nation,subregion) %>% 
  as.data.frame()

```

# 函数

+ 自己编写一个绘制交互表图形的函数`plot_table`。其中`x`为行向量，`y`为列向量，`xlab`为行标签，`ylab`为列标签。

```{r,message = F, comment = NA,warning = F,error=T,out.width='80%',fig.align='center'}
plot_table <- function(x,y,xlab=x,ylab=y){
  mar <- as.data.frame(table(x,y))
  ggplot2::ggplot(mar,aes(mar[,1],mar[,2])) +
  geom_tile(aes(fill=Freq),color='black') +
  scale_fill_gradient(low='white',high = 'steel blue')+
  geom_text(aes(label = Freq)) + labs(fill="频数",x=xlab,y=ylab)
}

data("titanic_train")
titanic <- titanic_train %>% 
  as.data.frame()

titanic %$%
plot_table(Sex,Survived)

titanic %$%
plot_table(Sex,Survived,"性别","是否生存")


```


```{r,message = F, comment = NA,warning = F,error=T}
scattplot <- function(x,y){
  plot(x,y)
  return(x+y)
}
x <- rnorm(10)
y <- rnorm(10,2,3)
scattplot(x,y)
```

# 样条

```{r,message = F, comment = NA,warning = F,error=T}
library(splines)
n = 100
x = rnorm(n)
## Some non-linear function of x
p = plogis(2 * cos(5 * x) - 1)
y = rbinom(n, 1, p)

model = glm(y ~ bs(x), family = binomial())
pred = predict(model, bs(x))
plot(x, pred)
```


```{r,message = F, comment = NA,warning = F,error=T}
require(stats); require(graphics)
bs(women$height, df = 5)
summary(fm1 <- lm(weight ~ bs(height, df = 5), data = women))

## example of safe prediction
plot(women, xlab = "Height (in)", ylab = "Weight (lb)")
ht <- seq(57, 73, length.out = 200)
lines(ht, predict(fm1, data.frame(height = ht)))
```

# 广义可加模型(Generalized Additive Models)

```{r,message = F, comment = NA,warning = F,error=T}
library(mgcv)
set.seed(2) ## simulate some data... 
dat <- gamSim(1,n=400,dist="normal",scale=2)
b <- gam(y~s(x0)+s(x1)+s(x2)+s(x3),data=dat)
summary(b)
plot(b,pages=1,residuals=TRUE)  ## show partial residuals
plot(b,pages=1,seWithMean=TRUE) ## `with intercept' CIs
## run some basic model checks, including checking
## smoothing basis dimensions...
gam.check(b)
```
```{r,message = F, comment = NA,warning = F,error=T}
require(mgcv)
require(nlme)
b0 <- lme(travel~1,data=Rail,~1|Rail,method="REML") 

b <- gam(travel~s(Rail,bs="re"),data=Rail,method="REML")

intervals(b0)
gam.vcomp(b)
anova(b)
plot(b)
```

