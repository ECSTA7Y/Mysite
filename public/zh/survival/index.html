<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <base target="_blank">
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Hugo 0.55.5" />


<title>生存分析云笔记 - Xiao Song</title>
<meta property="og:title" content="生存分析云笔记 - Xiao Song">


  <link href='../../favicon.ico' rel='icon' type='image/x-icon'/>



  








<link href='//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css' rel='stylesheet' type='text/css' />



<link rel="stylesheet" href="../../css/fonts.css" media="all">
<link rel="stylesheet" href="../../css/main.css" media="all">



  </head>
  <body>
    <div class="fixed-top">
      <header class="header">
        <nav class="nav">
  <a href="../../" class="nav-logo">
    <img src="../../images/logo.png"
         width="50"
         height="50"
         alt="Logo">
  </a>

  <ul class="nav-links">
    
    <li><a href="../../">Home</a></li>
    
    <li><a href="../../zh/zhresume/">Vitae</a></li>
    
    <li><a href="https://github.com/ECSTA7Y">GitHub</a></li>
    
    <li><a href="../../zh/reward/">Reward</a></li>
    
    <li><a href="../../en">English</a></li>
    
  </ul>
</nav>

      </header>

<link rel="stylesheet">

<main class="content" role="main">

  <article class="article">

    <h1 class="article-title">生存分析云笔记</h1>

    
    <span class="article-date">2019-05-23</span>
    

    <div class="article-content">
      


<p><img src="https://img.shields.io/badge/License-CC%20BY--NC--ND%204.0-brightgreen.svg" /></p>
<p>本文系复旦大学人口学系<a href="http://www.ssdpp.fudan.edu.cn/portal/1e2812ee711c4175a3304c7dbc7071e0/70VhqG.html">张震</a>老师和华东师范大学人口研究所<a href="https://faculty.ecnu.edu.cn/s/2160/main.jspy">李强</a>老师的数据分析课程笔记。</p>
<p>一个R生存分析应用的介绍网页<a href="https://rviews.rstudio.com/2017/09/25/survival-analysis-with-r/">Survival Analysis with R</a></p>
<p>生存分析应用：<a href="https://mp.weixin.qq.com/s/XrL2CmoxmJwdvnUDMMYT6w">移动通讯运营商的用户流失问题分析</a></p>
<p>两篇重要的中文文献：</p>
<p>李强, 张震. (2009). 生存分析中时间变量的选择[J]. 中国人口科学(6), 88-95.</p>
<p>李强, 徐刚, 陈丽梅.(2019) 生存分析的应用误区[J]. 中国人口科学(01):101-112.</p>
<hr />
<div id="section" class="section level2">
<h2>第一讲: 基本概念</h2>
<ul>
<li>社会调查只能观察到状态。人口学关心从一个状态到另一个状态转移的风险。试想每一种状态是一个格子，格子内部是人口频数。人口学能通过数频数的方式估计状态转移的风险。<strong>在一个状态内待的时间和风险有着密切的关系</strong>。</li>
</ul>
<p><span class="math inline">\(T\)</span>为随机变量，上帝也不知道</p>
<p>生存函数：<span class="math inline">\(S(t) = P(T &gt; t)\)</span>。是存活概率也是存活百分比。</p>
<p>失效函数(Failure Function)：<span class="math inline">\(F(t)\)</span>,<span class="math inline">\(S(t) = 1 - F(t)\)</span>, <span class="math inline">\(F(t)\)</span>是T的累积分布函数。</p>
<p><span class="math inline">\(f(t) = \frac{{dF(t)}}{{dt}}\)</span>，即<span class="math inline">\(S(t)\)</span>的斜率。等价于生存时间的概率密度函数(直方图)。是无条件的风险。</p>
<p>风险函数: <span class="math display">\[h(t) = \mathop {\lim }\limits_{\Delta t \to 0} \frac{{P(t \le T &lt; t + \Delta t|T \ge t)}}{{\Delta t}},0 &lt; h(t) &lt;  + \infty \]</span></p>
<p><span class="math inline">\(h(t)\)</span>不是密度也不是概率。</p>
<ul>
<li><p>censor(删截): 知道事件发生，但不知道事件何时发生。事件观测期内无法观测。</p></li>
<li><p>truncate(截平): 只有在给定观测期内的个体才会被观测到的状况。样本选择问题。生存函数对应于某种条件概率。</p>
<ul>
<li>censor涉及到事件，truncate涉及到暴露量。</li>
</ul></li>
<li><p>能活到预期寿命者总是62%</p></li>
</ul>
<hr />
</div>
<div id="mle" class="section level2">
<h2>第二讲: 最大似然估计(MLE)</h2>
<p>Cox回归避开了模型分布假定的问题。</p>
<ul>
<li><p>假定数据独立同分布。</p>
<p>似然函数：</p></li>
</ul>
<p><span class="math display">\[{\rm{L}}(\lambda ){\rm{ = }}\prod\limits_{i = 1}^\pi  {P(T = t)}  = \prod {f({t_i})}\]</span><br />
<span class="math inline">\(\delta\)</span>是积分小区间</p>
<p><span class="math display">\[P(T = t) \approx 2\delta f(t)\]</span></p>
<ul>
<li>发生风险率(Occurrence-exposure rate)
<span class="math display">\[\widehat \lambda  = \frac{1}{{\bar t }} = \frac{n}{{\sum\limits_{}^{} {{t_i}} }}\]</span>
<span class="math inline">\(\sum\limits_{}^{} {{t_i}}\)</span>是历险人年数。<span class="math inline">\(n\)</span>是事件发生数。<br />
<span class="math inline">\(\lambda\)</span>是个概率估计。</li>
</ul>
<div id="censored" class="section level3">
<h3>删截(Censored)样本的似然函数</h3>
<ul>
<li>完全样本的似然函数是在该时点t的密度函数<span class="math inline">\(f({t_i})\)</span>。右删截数据是生存函数<span class="math inline">\(S({C_r})\)</span>。左删截数据为累计分布函数<span class="math inline">\(1 - S({C_l})\)</span>。区间删截为在该时段内的发生概率<span class="math inline">\(S(L) - S(R)\)</span>。</li>
</ul>
<p>右删截：
<span class="math display">\[P({t_i} &gt; 40) = S(40)\]</span></p>
<ul>
<li>40岁删截</li>
</ul>
<p><span class="math display">\[L(\lambda ) = \prod\limits_{observed} {f({t_i})}  \cdot \prod\limits_{censored} {S(40)}\]</span></p>
<p>Assume the first <span class="math inline">\(d\)</span> individuals died, <span class="math inline">\((n-d)\)</span> ware alive at 40:</p>
<p><span class="math display">\[\hat \lambda  = \frac{d}{{\sum {{t_i} - (n - d) \cdot 40} }}\]</span></p>
<p>分子为事件发生数。</p>
<p>人口学、医学中最多的情况是left-truncated &amp; right-cencored(LT-RC)数据。</p>
<p>非参数模型Aalen’s additive regression model可以替代Cox模型。R的<code>survival</code>包的<code>aareg</code>函数可以进行拟合。</p>
<hr />
</div>
</div>
<div id="section-1" class="section level2">
<h2>第三讲: 生存分析估计</h2>
<p>R生存分析介绍：<a href="http://www.openintro.org/stat/surv.php">survival analysis in R</a></p>
<pre class="r"><code>library(survival)
library(haven) 
library(ggplot2)
library(dplyr)
library(ggfortify)</code></pre>
<ul>
<li>数据介绍：<br />
<code>los1</code>:时间变量<br />
<code>cen_r</code>:事件是否发生,被收养成功<br />
<code>female</code>:性别<br />
<code>ec</code>:进入队列<br />
<code>minc</code>:母亲月均收入<br />
(minc=1, $0-$299; minc=2, $300-$999; minc=3, $1,000-$1,999;
minc=4,$2000+)<br />
<code>age</code>:年龄<br />
<code>black</code>:种族</li>
</ul>
<div id="kaplanmeier-estimator-" class="section level3">
<h3>Kaplan–Meier estimator | 卡普兰迈耶法</h3>
<p>又称乘积极限法(Product-Limit Method), 公式如下：</p>
<p><span class="math display">\[{\rm{\hat S}}(t) = \prod\limits_{{t_i} \le t} {(1 - {{\hat q}_i})}  = \prod\limits_{{t_i} \le t} {(1 - {{{d_i}} \over {{n_i}}})}\]</span></p>
<p><span class="math inline">\(n_i\)</span>是在时间<span class="math inline">\(t_i\)</span>中的历险人数，<span class="math inline">\(d_i\)</span>是事件发生数。</p>
<pre class="r"><code>table(cwg$event)</code></pre>
<pre><code>
  0   1 
978 300 </code></pre>
<pre class="r"><code># Kaplan Meier Survival Curve
km &lt;- with(cwg, Surv(los1, event == 1))
head(km,10) #删截后面有+号</code></pre>
<pre><code> [1]  4.30000000+  6.00000000  21.00000000+  0.03333333  10.63333333 
 [6]  4.43333333+  6.86666667+  4.46666667+  2.40000000+  9.00000000 </code></pre>
<pre class="r"><code>km_fit &lt;- survfit(km ~ 1, data=cwg)
km_fit #生存分析概要</code></pre>
<pre><code>Call: survfit(formula = km ~ 1, data = cwg)

      n  events  median 0.95LCL 0.95UCL 
   1278     300      NA      NA      NA </code></pre>
<div class="figure" style="text-align: center">
<img src="../../img/survival/life.jpg" alt=" " width="100%" />
<p class="caption">
</p>
</div>
<p>生存函数的Kaplan–Meier estimator就是<span class="math inline">\(nPx\)</span>列的累乘。</p>
<pre class="r"><code>summary(km_fit, times = c(0.2*(1:25))) #这个表和生命表等价</code></pre>
<pre><code>Call: survfit(formula = km ~ 1, data = cwg)

 time n.risk n.event survival std.err lower 95% CI upper 95% CI
  0.2   1237      24    0.981 0.00382        0.974        0.989
  0.4   1226       5    0.977 0.00420        0.969        0.985
  0.6   1219       0    0.977 0.00420        0.969        0.985
  0.8   1215       1    0.976 0.00427        0.968        0.985
  1.0   1211       3    0.974 0.00448        0.965        0.983
  1.2   1199       3    0.972 0.00468        0.962        0.981
  1.4   1187       1    0.971 0.00475        0.961        0.980
  1.6   1183       2    0.969 0.00488        0.960        0.979
  1.8   1175       1    0.968 0.00494        0.959        0.978
  2.0   1163       4    0.965 0.00520        0.955        0.975
  2.2   1160       1    0.964 0.00526        0.954        0.974
  2.4   1141       3    0.962 0.00544        0.951        0.972
  2.6   1134       4    0.958 0.00568        0.947        0.969
  2.8   1105      11    0.949 0.00628        0.937        0.961
  3.0   1098       0    0.949 0.00628        0.937        0.961
  3.2   1083       7    0.943 0.00665        0.930        0.956
  3.4   1062      10    0.934 0.00714        0.920        0.948
  3.6   1055       3    0.931 0.00728        0.917        0.946
  3.8   1046       3    0.929 0.00742        0.914        0.943
  4.0   1041       4    0.925 0.00760        0.910        0.940
  4.2   1031       7    0.919 0.00791        0.904        0.935
  4.4   1019       3    0.916 0.00804        0.901        0.932
  4.6   1008       4    0.913 0.00821        0.897        0.929
  4.8    991       8    0.905 0.00853        0.889        0.922
  5.0    977       7    0.899 0.00881        0.882        0.916</code></pre>
<div class="figure" style="text-align: center">
<img src="../../img/survival/life2.jpg" alt=" " width="100%" />
<p class="caption">
</p>
</div>
<pre class="r"><code>autoplot(km_fit) #ggplot2风格KM图</code></pre>
<p><img src="../../post/survival_files/figure-html/unnamed-chunk-7-1.png" width="70%" style="display: block; margin: auto;" /></p>
<pre class="r"><code>km_trt_fit &lt;- survfit(km ~ female, data=cwg)#分性别KM估计
autoplot(km_trt_fit) #图中+号可能是&quot;打结&quot; ties?</code></pre>
<p><img src="../../post/survival_files/figure-html/unnamed-chunk-7-2.png" width="70%" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="cox" class="section level2">
<h2>Cox比例风险模型</h2>
<p><span class="math display">\[\ln {h_i}(t) = \ln {h_0}(t) + {\beta _1}{X_1} + {\beta _2}{X_2} +  \cdot  \cdot  \cdot  + {\beta _p}{X_p}\]</span></p>
<ul>
<li><span class="math inline">\({h_i}(t)\)</span>是个体i在时间t时的风险值。<span class="math inline">\({h_0}(t)\)</span>是所有个体在时间t时的非参数风险函数值。<span class="math inline">\({\beta_p}{X_p}\)</span>是对个体i的解释变量和系数。</li>
</ul>
<p><span class="math display">\[{{h(t|{X_i})} \over {h(t|{X_j})}} = {{{h_0}(t)\exp (X_i^T\beta )} \over {{h_0}(t)\exp (X_j^T\beta )}} = \exp [(X_i^T - X_j^T)\beta ]\]</span></p>
<ul>
<li><p>两个分别具有协变量<span class="math inline">\({X_i}\)</span>和<span class="math inline">\({X_j}\)</span>的个体，其风险函数之比为相对危险度（risk ration，RR）或风险比（hazard ration，HR）</p></li>
<li><p><span class="math inline">\({h_i}(t)\)</span>和<span class="math inline">\({h_0}(t)\)</span>随时间变化。在满足比例风险假定后，不同特征样本的风险比（hazard ration，HR）不随时间变化。所以系数是固定的。无时变变量的Cox模型为宽数据(wide data)。</p></li>
</ul>
<pre class="r"><code>cwg$ec &lt;- as.factor(cwg$ec)
cwg$minc &lt;- as.factor(cwg$minc)
cwg$age &lt;- as.factor(cwg$age)

coxreg &lt;- coxph(km ~ ec + age + female +black + minc, data = cwg)
summary(coxreg)</code></pre>
<pre><code>Call:
coxph(formula = km ~ ec + age + female + black + minc, data = cwg)

  n= 1278, number of events= 300 

           coef exp(coef) se(coef)      z Pr(&gt;|z|)    
ec2    -0.06402   0.93799  0.15623 -0.410   0.6820    
ec3    -0.31251   0.73161  0.15042 -2.078   0.0377 *  
age1    0.23566   1.26575  0.17845  1.321   0.1866    
age2    0.12146   1.12915  0.18000  0.675   0.4998    
age3    0.36410   1.43921  0.18088  2.013   0.0441 *  
age4    0.18543   1.20374  0.19518  0.950   0.3421    
female  0.05917   1.06095  0.11604  0.510   0.6101    
black  -0.17321   0.84096  0.12882 -1.345   0.1788    
minc2   0.86616   2.37777  0.12615  6.866 6.60e-12 ***
minc3   0.90591   2.47418  0.21039  4.306 1.66e-05 ***
minc4   1.54650   4.69499  0.30848  5.013 5.35e-07 ***
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1

       exp(coef) exp(-coef) lower .95 upper .95
ec2       0.9380     1.0661    0.6906    1.2740
ec3       0.7316     1.3669    0.5448    0.9825
age1      1.2657     0.7900    0.8922    1.7957
age2      1.1291     0.8856    0.7935    1.6068
age3      1.4392     0.6948    1.0096    2.0516
age4      1.2037     0.8307    0.8211    1.7647
female    1.0610     0.9425    0.8451    1.3319
black     0.8410     1.1891    0.6533    1.0825
minc2     2.3778     0.4206    1.8569    3.0447
minc3     2.4742     0.4042    1.6381    3.7369
minc4     4.6950     0.2130    2.5648    8.5944

Concordance= 0.648  (se = 0.016 )
Likelihood ratio test= 79.58  on 11 df,   p=2e-12
Wald test            = 83.79  on 11 df,   p=3e-13
Score (logrank) test = 90.95  on 11 df,   p=1e-14</code></pre>
<pre class="r"><code>cox_fit &lt;- survfit(coxreg)
autoplot(cox_fit) #拟合值</code></pre>
<p><img src="../../post/survival_files/figure-html/unnamed-chunk-8-1.png" width="100%" style="display: block; margin: auto;" /></p>
<pre class="r"><code>##C-指数 Harrell&#39;s concordance index
#coxreg$concordance
concordance(km ~ predict(coxreg), data = cwg)</code></pre>
<pre><code>Call:
concordance.formula(object = km ~ predict(coxreg), data = cwg)

n= 1278 
Concordance= 0.3518 se= 0.0164
concordant discordant     tied.x     tied.y    tied.xy 
     96999     179888       2803        246         19 </code></pre>
<p><a href="https://blog.csdn.net/fjsd155/article/details/84669331">生存模型的C-index（C指数）</a></p>
<p><a href="https://blog.csdn.net/anshiquanshu/article/details/53438438">C-index/C-statistic 计算的5种不同方法及比较</a></p>
</div>
<div id="aalens-additive-regression-model" class="section level2">
<h2><a href="http://www.medicine.mcgill.ca/epidemiology/hanley/bios601/Encyclopedia%20of%20Biostatistics2ndEd2005.pdf">Aalen’s additive regression model</a></h2>
<pre class="r"><code>aaregfit &lt;-aareg(km ~ ec + age + female +black + minc, data = cwg)
aaregfit</code></pre>
<pre><code>Call:
aareg(formula = km ~ ec + age + female + black + minc, data = cwg)

  n= 1278 
    152 out of 152 unique event times used

             slope      coef se(coef)      z        p
Intercept  0.02740  8.65e-04 0.000222  3.900 9.64e-05
ec2       -0.00728 -7.42e-05 0.000182 -0.406 6.84e-01
ec3       -0.01410 -3.27e-04 0.000167 -1.960 5.01e-02
age1       0.00411  1.92e-04 0.000176  1.090 2.77e-01
age2       0.00114  6.14e-05 0.000167  0.367 7.13e-01
age3       0.01330  3.32e-04 0.000199  1.670 9.50e-02
age4       0.00431  1.31e-04 0.000198  0.663 5.07e-01
female     0.00517  6.42e-05 0.000123  0.522 6.02e-01
black     -0.00856 -1.81e-04 0.000151 -1.200 2.32e-01
minc2      0.03100  1.02e-03 0.000177  5.740 9.66e-09
minc3      0.02080  1.15e-03 0.000363  3.180 1.49e-03
minc4      0.08800  2.66e-03 0.000980  2.720 6.60e-03

Chisq=59.53 on 11 df, p=1.13e-08; test weights=aalen</code></pre>
<pre class="r"><code>autoplot(aaregfit)</code></pre>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-9"></span>
<img src="../../post/survival_files/figure-html/unnamed-chunk-9-1.png" alt="协变量作用如何随时间变化" width="100%" />
<p class="caption">
Figure 1: 协变量作用如何随时间变化
</p>
</div>
</div>

    </div>
  </article>

  
<section id="comments">
  <div id="disqus_thread"></div>
  <script>
  var disqus_config = function () {
  
  };
  (function() {
    var inIFrame = function() {
      var iframe = true;
      try { iframe = window.self !== window.top; } catch (e) {}
      return iframe;
    };
    if (inIFrame()) return;
    var d = document, s = d.createElement('script');
    s.src = '//Xiao Song.disqus.com/embed.js'; s.async = true;
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>



</main>

      <footer class="footer">
        <ul class="footer-links">
          
        </ul>
      </footer>

    </div>
    



<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>



<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/r.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>



    
<script src="../../js/math-code.js"></script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>


    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-144652310-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

  </body>
</html>

