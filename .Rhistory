student <- read_dta("E:/edu/data/stu.dta")
student$ids <- student$ids %>% formatC(., width=5, flag="0", format="fg")
stu <- student %>%
lapply(unclass) %>%
as.data.frame() %>%
select(ctyids,schids,clsids,ids,grade9,tr_chn,tr_mat,tr_eng,stdchn, stdmat,stdeng,a01,b01,b06,b07,b1001,b1002,b1003,b11,b13,b27,b2201,b2202, b31,sweight) %>%
mutate(sex=recode(a01,'1'= 'male', '2'='female'),
onechi=recode(b01,'1'='yes','2'='no'),
drunk=recode(b1001,'1'='no','2'='yes'),
qurel=recode(b1002,'1'='no','2'='yes'),
relation=recode(b1003,'1'= 'no', '2'='yes'),
desk=recode(b11,'1'='yes','2'='no'),
net=recode(b13,'0'='no','1'='no_net','2'='yes'),
maedu=recode(b06,'1'=0,'2'=6,'3'=9,'4'=12,'5'=12,'6'=12,'7'=15,'8'=16,'9'=19),
faedu=recode(b07,'1'=0,'2'=6,'3'=9,'4'=12,'5'=12,'6'=12,'7'=15,'8'=16,'9'=19),
eduexp=recode(b31,'1'=9,'2'=9,'3'=12,'4'=12,'5'=12,'6'=15,'7'=16,'8'=19,'9'=22,'10'=7),
dialect=recode(b27,'1'="madn",'2'='bt','3'='dia','4'='oth'),
chmwk=recode(b2201,'1'="no",'2'='1t2','3'='3t4','4'='evd'),
chcos=recode(b2202,'1'="no",'2'='1t2','3'='3t4','4'='evd')
)
classpre <- read_dta("E:/edu/data/class.dta")
student$ids <- student$ids %>% formatC(., width=5, flag="0", format="fg")
class <- classpre %>%
lapply(unclass) %>%
as.data.frame() %>%
select(clsids, schids,hrb06,hra07,hra08,hra09,hra01, hrb02, hrb08a, hrb08b) %>%
rename(classtm=hra07,clpre=hra08,revitm=hra09,know=hrb02) %>%
mutate(subject=recode(hra01,'0'='oth','1'='mat','2'='lit','3'='eng'),
drsmok=recode(hrb06,'1'='no','2'='yes','3'='yes','4'='yes'),
commhr=hrb08a+hrb08b/60,
know=as.factor(know)
)
schoolpre <- read_dta("E:/edu/data/school.dta")
school <- schoolpre %>%
lapply(unclass) %>%
as.data.frame() %>%
select(schids, pla01, pla13, pla16, pla17, pla18, plc0102, ple1101, ple1102, ple1103, ple1104, plc0601) %>%
rename(schcsrm=pla13,comno = pla16,buget = pla18,eduqua=plc0102,teainc=plc0601) %>%
mutate(schtype=recode(pla01,'1'='public','2'='oth','3'='oth','4'='oth'),
fight=recode(ple1101,'1'='no','3'='yes','4'='yes'),
brkpb=recode(ple1102,'1'='no','2'='yes','3'='yes','4'='yes'),
bknum=replace(pla17,pla17>40000,NA),
smok=recode(ple1103,'1'='no','2'='yes','3'='yes','4'='yes'),
drink=recode(ple1104,'1'='no','2'='yes','3'='yes'),
)
parentpre <- read_dta("E:/edu/data/parent.dta")
parentpre$ids <- parentpre$ids %>% formatC(., width=5, flag="0", format="fg")
parent <- parentpre %>%
lapply(unclass) %>%
as.data.frame() %>%
select(ids,ba06,ba03, ba05, ba13, ba15, ba16, ba18, ba21, bd05, be07, be06, be24) %>%
mutate(qianzi=as.factor(ba05),
futcfd=as.factor(ba21),
dial=recode(ba15,'1'='madn','2'='bt','3'='dia','4'='oth'),
chidia=recode(ba16,'1'='madn','2'='bt','3'='dia','4'='oth'),
eduyexp=recode(ba18,'1'=9,'2'=9,'3'=12,'4'=12,'5'=12,'6'=15,'7'=16,'8'=19,'9'=22,'10'=7),
huko=recode(bd05,'1'='agr','2'='non','3'='oth','4'='oth'),
eduy=recode(be07,'1'=0,'2'=6,'3'=9,'4'=12,'5'=12,'6'=12,'7'=15,'8'=16,'9'=19),
dangy=recode(be06,'1'='yes','2'='no','2'='no'),
houspro=recode(be24,'1'='yes','2'='no'),
lifetm=replace(ba13,ba13>15,NA),
clfee=replace(ba03,ba03>10000,NA),
money=replace(ba06,ba06>250,NA)
)
stupat <- left_join(stu,parent,by="ids")
stucls <- left_join(stupat,class,by="clsids",copy=T)
stusch <- left_join(stucls,school,by="schids",copy=T)
View(stucls)
View(stupat)
class(stupat$clsids)
class(class$clsids)
stupat <- rename(stupat,'schids.x'='schids')
stusch <- left_join(stucls,school,by="schids",copy=T)
stupat <- rename(stupat,'schids'='schids.x')
stusch <- left_join(stucls,school,by="schids",copy=T)
stucls <- rename(stucls,'schids'='schids.x')
stusch <- left_join(stucls,school,by="schids",copy=T)
View(stusch)
stucls <- left_join(stupat,class,by="clsids",copy=T, suffix = c("", ""))
stucls <- left_join(stupat,class,by="clsids",copy=T, suffix = c("", " "))
stusch <- left_join(stucls,school,by="schids",copy=T)
stupat <- left_join(stu,parent,by="ids")
stucls <- left_join(stupat,class,by="clsids",copy=T, suffix = c("", " "))
stusch <- left_join(stucls,school,by="schids",copy=T)
stupat <- left_join(stu,parent,by="ids") %>%
left_join(.,class,by="clsids",copy=T, suffix = c("", " ")) %>%
stusch <- left_join(.,school,by="schids",copy=T)
stupat <- left_join(stu,parent,by="ids") %>%
left_join(.,class,by="clsids",copy=T, suffix = c("", " ")) %>%
left_join(.,school,by="schids",copy=T)
rm(list=ls())
stutestpre <- read_dta("E:/data/CEPS/2014-2015/cepsw2studentEN.dta")
stutestpre$ids <- stutestpre$ids %>% formatC(., width=5, flag="0", format="fg")
View(stutestpre)
stutestpre <- read_dta("E:/data/CEPS/2014-2015/cepsw2studentEN.dta")
stutestpre$ids <- stutestpre$ids %>% formatC(., width=5, flag="0", format="fg")
stutest <- stutestpre %>%
lapply(unclass) %>%
as.data.frame() %>%
select(w2mat,w2upmat)
View(stutest)
rm(list=ls())
stutestpre <- read_dta("E:/data/CEPS/2014-2015/cepsw2studentEN.dta")
stutestpre$ids <- stutestpre$ids %>% formatC(., width=5, flag="0", format="fg")
stutest <- stutestpre %>%
lapply(unclass) %>%
as.data.frame() %>%
select(ids,w2mat,w2upmat)
ceps <- left_join(stu,parent,by="ids") %>%
left_join(.,class,by="clsids",copy=T, suffix = c("", " ")) %>%
left_join(.,school,by="schids",copy=T)
library(haven)
library(dplyr)
library(tidyr)
library(magrittr)
student <- read_dta("E:/edu/data/stu.dta")
student$ids <- student$ids %>% formatC(., width=5, flag="0", format="fg")
stu <- student %>%
lapply(unclass) %>%
as.data.frame() %>%
select(ctyids,schids,clsids,ids,grade9,tr_chn,tr_mat,tr_eng,stdchn, stdmat,stdeng,a01,b01,b06,b07,b1001,b1002,b1003,b11,b13,b27,b2201,b2202, b31,sweight) %>%
mutate(sex=recode(a01,'1'= 'male', '2'='female'),
onechi=recode(b01,'1'='yes','2'='no'),
drunk=recode(b1001,'1'='no','2'='yes'),
qurel=recode(b1002,'1'='no','2'='yes'),
relation=recode(b1003,'1'= 'no', '2'='yes'),
desk=recode(b11,'1'='yes','2'='no'),
net=recode(b13,'0'='no','1'='no_net','2'='yes'),
maedu=recode(b06,'1'=0,'2'=6,'3'=9,'4'=12,'5'=12,'6'=12,'7'=15,'8'=16,'9'=19),
faedu=recode(b07,'1'=0,'2'=6,'3'=9,'4'=12,'5'=12,'6'=12,'7'=15,'8'=16,'9'=19),
eduexp=recode(b31,'1'=9,'2'=9,'3'=12,'4'=12,'5'=12,'6'=15,'7'=16,'8'=19,'9'=22,'10'=7),
dialect=recode(b27,'1'="madn",'2'='bt','3'='dia','4'='oth'),
chmwk=recode(b2201,'1'="no",'2'='1t2','3'='3t4','4'='evd'),
chcos=recode(b2202,'1'="no",'2'='1t2','3'='3t4','4'='evd')
)
#rm(list=ls())
stutestpre <- read_dta("E:/data/CEPS/2014-2015/cepsw2studentEN.dta")
stutestpre$ids <- stutestpre$ids %>% formatC(., width=5, flag="0", format="fg")
stutest <- stutestpre %>%
lapply(unclass) %>%
as.data.frame() %>%
select(ids,w2mat,w2upmat)
classpre <- read_dta("E:/edu/data/class.dta")
student$ids <- student$ids %>% formatC(., width=5, flag="0", format="fg")
class <- classpre %>%
lapply(unclass) %>%
as.data.frame() %>%
select(clsids, schids,hrb06,hra07,hra08,hra09,hra01, hrb02, hrb08a, hrb08b) %>%
rename(classtm=hra07,clpre=hra08,revitm=hra09,know=hrb02) %>%
mutate(subject=recode(hra01,'0'='oth','1'='mat','2'='lit','3'='eng'),
drsmok=recode(hrb06,'1'='no','2'='yes','3'='yes','4'='yes'),
commhr=hrb08a+hrb08b/60,
know=as.factor(know)
)
schoolpre <- read_dta("E:/edu/data/school.dta")
school <- schoolpre %>%
lapply(unclass) %>%
as.data.frame() %>%
select(schids, pla01, pla13, pla16, pla17, pla18, plc0102, ple1101, ple1102, ple1103, ple1104, plc0601) %>%
rename(schcsrm=pla13,comno = pla16,buget = pla18,eduqua=plc0102,teainc=plc0601) %>%
mutate(schtype=recode(pla01,'1'='public','2'='oth','3'='oth','4'='oth'),
fight=recode(ple1101,'1'='no','3'='yes','4'='yes'),
brkpb=recode(ple1102,'1'='no','2'='yes','3'='yes','4'='yes'),
bknum=replace(pla17,pla17>40000,NA),
smok=recode(ple1103,'1'='no','2'='yes','3'='yes','4'='yes'),
drink=recode(ple1104,'1'='no','2'='yes','3'='yes'),
)
parentpre <- read_dta("E:/edu/data/parent.dta")
parentpre$ids <- parentpre$ids %>% formatC(., width=5, flag="0", format="fg")
parent <- parentpre %>%
lapply(unclass) %>%
as.data.frame() %>%
select(ids,ba06,ba03, ba05, ba13, ba15, ba16, ba18, ba21, bd05, be07, be06, be24) %>%
mutate(qianzi=as.factor(ba05),
futcfd=as.factor(ba21),
dial=recode(ba15,'1'='madn','2'='bt','3'='dia','4'='oth'),
chidia=recode(ba16,'1'='madn','2'='bt','3'='dia','4'='oth'),
eduyexp=recode(ba18,'1'=9,'2'=9,'3'=12,'4'=12,'5'=12,'6'=15,'7'=16,'8'=19,'9'=22,'10'=7),
huko=recode(bd05,'1'='agr','2'='non','3'='oth','4'='oth'),
eduy=recode(be07,'1'=0,'2'=6,'3'=9,'4'=12,'5'=12,'6'=12,'7'=15,'8'=16,'9'=19),
dangy=recode(be06,'1'='yes','2'='no','2'='no'),
houspro=recode(be24,'1'='yes','2'='no'),
lifetm=replace(ba13,ba13>15,NA),
clfee=replace(ba03,ba03>10000,NA),
money=replace(ba06,ba06>250,NA)
)
ceps <- left_join(stu,parent,by="ids") %>%
left_join(.,class,by="clsids",copy=T, suffix = c("", " ")) %>%
left_join(.,school,by="schids",copy=T)
cepstest <- left_join(ceps,stutest,by="ids")
View(cepstest)
summary(ceps$tr_mat)
table(ceps$tr_mat)
ggplot2::ggplot(ceps,aes(tr_mat))+
geom_hist()
ggplot2::ggplot(ceps,aes(tr_mat))+
geom_histogram()
library(ggplot2)
ggplot(ceps,aes(tr_mat))+
geom_histogram()
library(ggplot2)
ggplot(ceps,aes(tr_mat))+
geom_histogram(bins=500)
library(ggplot2)
ggplot(ceps,aes(tr_mat))+
geom_histogram(bins=50)
View(cepstest)
library(haven)
library(ggplot2)
library(dplyr)
library(pROC)
library(tidyr)
library(randomForest)
library(mice)
`%>%` <- magrittr::`%>%`
library(readr)
ceps <- read_csv("C:/Users/xsong/Desktop/table/ceps.imputed.csv")
ceps <- ceps %>%
select(sdtotal,everything()) %>%
na.omit()
#options(na.action="na.fail")
library(glmnet)
x_train <- model.matrix(sdtotal ~ schids + sex + onechi +  maedu +  faedu + drunk + qurel + relation +  desk + net + dialect + chkhmwk + chkcouse + classtm + clpre + revitm + subject + know + drsmok + commhr + schtype + schcsrm +  comno +  bknum + buget + eduqua + fight + brkpb + smok +  drink +  teainc + money + clfee + qianzi + lifetm +  dial +  chidia +  futcfd +  huko + eduy +  dangy + houspro,ceps)[,-1]
y_train <- ceps %>%
select(sdtotal) %>%
unlist() %>%
as.numeric()
#cepsmat <- ceps %>%
# select(sex,onechi,maedu,faedu, drunk,qurel,relation,desk,net,dialect,chkhmwk, chkcouse , classtm,clpre,revitm,subject,know, drsmok,commhr,schtype,schcsrm,comno,bknum, buget,eduqua,fight,brkpb,smok,drink, teainc,money,clfee,qianzi,lifetm,dial,chidia,futcfd,huko,eduy,dangy,houspro) %>%
#  as.matrix() %>%
#  na.omit()
#sdtotal <- as.matrix(ceps$sdtotal)
lasso_mod <- glmnet(x_train,
y_train,
alpha = 1)
library(plotmo) # for plot_glmnet
plot_glmnet(lasso_mod,xvar='lambda',label=10)
#plot(lasso_mod,xvar="lambda",label=F,ylab='系数')
#lasso_mod
#cof <- coef(lasso_mod)
cvfit <- cv.glmnet(x_train,
y_train,
alpha = 1)
cvfit$lambda.min
cvfit$lambda.1se
#plot(cvfit)
?xgboost
library(xgboost)
??xgboost
??read_csv
library(klaR)
browseVignettes('xgboost')
library(xgboost)
data(agaricus.train, package='xgboost')
data(agaricus.test, package='xgboost')
train <- agaricus.train
test <- agaricus.test
bst <- xgboost(data = train$data, label = train$label, max_depth = 2, eta = 1,
nrounds = 2, objective = "binary:logistic")
summary(bst)
pred <- predict(bst, test$data)
pred
dtest <- xgb.DMatrix(test$data, label = test$label)
watchlist <- list(eval = dtest, train = dtrain)
dtrain <- xgb.DMatrix(train$data, label = train$label)
dtest <- xgb.DMatrix(test$data, label = test$label)
watchlist <- list(eval = dtest, train = dtrain)
param <- list(max_depth = 2, eta = 1, silent = 1)
bst <- xgb.train(param, dtrain, nrounds = 2, watchlist, logregobj, evalerror, maximize = FALSE)
logregobj <- function(preds, dtrain) {
labels <- getinfo(dtrain, "label")
preds <- 1/(1 + exp(-preds))
grad <- preds - labels
hess <- preds * (1 - preds)
return(list(grad = grad, hess = hess))
}
dtrain <- xgb.DMatrix(train$data, label = train$label)
dtest <- xgb.DMatrix(test$data, label = test$label)
watchlist <- list(eval = dtest, train = dtrain)
param <- list(max_depth = 2, eta = 1, silent = 1)
bst <- xgb.train(param, dtrain, nrounds = 2, watchlist, logregobj, evalerror, maximize = FALSE)
logregobj <- function(preds, dtrain) {
labels <- getinfo(dtrain, "label")
preds <- 1/(1 + exp(-preds))
grad <- preds - labels
hess <- preds * (1 - preds)
return(list(grad = grad, hess = hess))
}
evalerror <- function(preds, dtrain) {
labels <- getinfo(dtrain, "label")
err <- sqrt(mean((preds-labels)^2))
return(list(metric = "MSE", value = err))
}
dtrain <- xgb.DMatrix(train$data, label = train$label)
dtest <- xgb.DMatrix(test$data, label = test$label)
watchlist <- list(eval = dtest, train = dtrain)
param <- list(max_depth = 2, eta = 1, silent = 1)
bst <- xgb.train(param, dtrain, nrounds = 2, watchlist, logregobj, evalerror, maximize = FALSE)
logregobj <- function(preds, dtrain) {
labels <- getinfo(dtrain, "label")
preds <- 1/(1 + exp(-preds))
grad <- preds - labels
hess <- preds * (1 - preds)
return(list(grad = grad, hess = hess))
}
evalerror <- function(preds, dtrain) {
labels <- getinfo(dtrain, "label")
err <- sqrt(mean((preds-labels)^2))
return(list(metric = "MSE", value = err))
}
dtrain <- xgb.DMatrix(train$data, label = train$label)
dtest <- xgb.DMatrix(test$data, label = test$label)
watchlist <- list(eval = dtest, train = dtrain)
param <- list(max_depth = 2, eta = 1, silent = 1)
bst <- xgb.train(param, dtrain, nrounds = 2, watchlist, logregobj, evalerror, maximize = FALSE)
install.packages('DiagrammeR')
library(xgboost)
data(agaricus.train, package='xgboost')
data(agaricus.test, package='xgboost')
train <- agaricus.train
test <- agaricus.test
bst <- xgboost(data = train$data, label = train$label, max_depth = 2, eta = 1,nrounds = 2,verbose = 3, objective = "binary:logistic")
bst
importance_matrix <- xgb.importance(model = bst)
xgb.plot.importance(importance_matrix = importance_matrix)
xgb.plot.tree(model = bst)
xgb.plot.tree(model = bst)
?xgb.plot.tree
xgb.plot.tree(model = bst,trees=0:4)
xgb.plot.tree(model = bst,trees=0:4,show_node_id=T)
xgb.plot.tree(model = bst,trees=0:4,show_node_id=T,plot_width=5,plot_width=5)
xgb.plot.tree(model = bst,trees=0,show_node_id=T,plot_width=1500,plot_width=1500)
xgb.plot.tree(model = bst,trees=0,show_node_id=T,plot_width=5cm,plot_width=5cm)
xgb.plot.tree(model = bst,trees=0,show_node_id=T,plot_width='5cm',plot_width='5cm')
xgb.plot.tree(model = bst,trees=0,show_node_id=T)
setwd('F:\\Mysite\\Mysite')
blogdown:::serve_site()
browseVignettes('xgboost')
rm(list=ls())
library(haven)
library(dplyr)
library(tidyr)
library(magrittr)
student <- read_dta("E:/edu/data/stu.dta")
student$ids <- student$ids %>% formatC(., width=5, flag="0", format="fg")
stu <- student %>%
lapply(unclass) %>%
as.data.frame() %>%
select(ctyids,schids,clsids,ids,grade9,tr_chn,tr_mat,tr_eng,stdchn, stdmat,stdeng,a01,b01,b06,b07,b1001,b1002,b1003,b11,b13,b27,b2201,b2202, b31,sweight) %>%
mutate(sex=recode(a01,'1'= 'male', '2'='female'),
onechi=recode(b01,'1'='yes','2'='no'),
drunk=recode(b1001,'1'='no','2'='yes'),
qurel=recode(b1002,'1'='no','2'='yes'),
relation=recode(b1003,'1'= 'no', '2'='yes'),
desk=recode(b11,'1'='yes','2'='no'),
net=recode(b13,'0'='no','1'='no_net','2'='yes'),
maedu=recode(b06,'1'=0,'2'=6,'3'=9,'4'=12,'5'=12,'6'=12,'7'=15,'8'=16,'9'=19),
faedu=recode(b07,'1'=0,'2'=6,'3'=9,'4'=12,'5'=12,'6'=12,'7'=15,'8'=16,'9'=19),
eduexp=recode(b31,'1'=9,'2'=9,'3'=12,'4'=12,'5'=12,'6'=15,'7'=16,'8'=19,'9'=22,'10'=7),
dialect=recode(b27,'1'="madn",'2'='bt','3'='dia','4'='oth'),
chmwk=recode(b2201,'1'="no",'2'='1t2','3'='3t4','4'='evd'),
chcos=recode(b2202,'1'="no",'2'='1t2','3'='3t4','4'='evd')
)
#rm(list=ls())
stutestpre <- read_dta("E:/data/CEPS/2014-2015/cepsw2studentEN.dta")
stutestpre$ids <- stutestpre$ids %>% formatC(., width=5, flag="0", format="fg")
stutest <- stutestpre %>%
lapply(unclass) %>%
as.data.frame() %>%
select(ids,w2mat,w2upmat)
classpre <- read_dta("E:/edu/data/class.dta")
student$ids <- student$ids %>% formatC(., width=5, flag="0", format="fg")
class <- classpre %>%
lapply(unclass) %>%
as.data.frame() %>%
select(clsids, schids,hrb06,hra07,hra08,hra09,hra01, hrb02, hrb08a, hrb08b) %>%
rename(classtm=hra07,clpre=hra08,revitm=hra09,know=hrb02) %>%
mutate(subject=recode(hra01,'0'='oth','1'='mat','2'='lit','3'='eng'),
drsmok=recode(hrb06,'1'='no','2'='yes','3'='yes','4'='yes'),
commhr=hrb08a+hrb08b/60,
know=as.factor(know)
)
schoolpre <- read_dta("E:/edu/data/school.dta")
school <- schoolpre %>%
lapply(unclass) %>%
as.data.frame() %>%
select(schids, pla01, pla13, pla16, pla17, pla18, plc0102, ple1101, ple1102, ple1103, ple1104, plc0601) %>%
rename(schcsrm=pla13,comno = pla16,buget = pla18,eduqua=plc0102,teainc=plc0601) %>%
mutate(schtype=recode(pla01,'1'='public','2'='oth','3'='oth','4'='oth'),
fight=recode(ple1101,'1'='no','3'='yes','4'='yes'),
brkpb=recode(ple1102,'1'='no','2'='yes','3'='yes','4'='yes'),
bknum=replace(pla17,pla17>40000,NA),
smok=recode(ple1103,'1'='no','2'='yes','3'='yes','4'='yes'),
drink=recode(ple1104,'1'='no','2'='yes','3'='yes'),
)
parentpre <- read_dta("E:/edu/data/parent.dta")
parentpre$ids <- parentpre$ids %>% formatC(., width=5, flag="0", format="fg")
parent <- parentpre %>%
lapply(unclass) %>%
as.data.frame() %>%
select(ids,ba06,ba03, ba05, ba13, ba15, ba16, ba18, ba21, bd05, be07, be06, be24) %>%
mutate(qianzi=as.factor(ba05),
futcfd=as.factor(ba21),
dial=recode(ba15,'1'='madn','2'='bt','3'='dia','4'='oth'),
chidia=recode(ba16,'1'='madn','2'='bt','3'='dia','4'='oth'),
eduyexp=recode(ba18,'1'=9,'2'=9,'3'=12,'4'=12,'5'=12,'6'=15,'7'=16,'8'=19,'9'=22,'10'=7),
huko=recode(bd05,'1'='agr','2'='non','3'='oth','4'='oth'),
eduy=recode(be07,'1'=0,'2'=6,'3'=9,'4'=12,'5'=12,'6'=12,'7'=15,'8'=16,'9'=19),
dangy=recode(be06,'1'='yes','2'='no','2'='no'),
houspro=recode(be24,'1'='yes','2'='no'),
lifetm=replace(ba13,ba13>15,NA),
clfee=replace(ba03,ba03>10000,NA),
money=replace(ba06,ba06>250,NA)
)
setwd('F:\\Mysite\\Mysite')
blogdown:::serve_site()
ceps <- left_join(stu,parent,by="ids") %>%
left_join(.,class,by="clsids",copy=T, suffix = c("", " ")) %>%
left_join(.,school,by="schids",copy=T)
cepstest <- left_join(ceps,stutest,by="ids")
View(ceps)
View(cepstest)
View(stutest)
stutest$w2upmat
table(stutest$w2upmat)
cepstest <- left_join(ceps,stutest,by="ids")
str(cepstest)
rm(list=ls())
student <- read_dta("E:/data/CEPS/2013-2014/cepsw1studentEN.dta")
student$ids <- student$ids %>% formatC(., width=5, flag="0", format="fg")
stu <- student %>%
lapply(unclass) %>%
as.data.frame() %>%
select(ctyids,schids,clsids,ids,grade9,tr_chn,tr_mat,tr_eng,stdchn, stdmat,stdeng,a01,b01,b06,b07,b1001,b1002,b1003,b11,b13,b27,b2201,b2202, b31,sweight) %>%
mutate(sex=recode(a01,'1'= 'male', '2'='female'),
onechi=recode(b01,'1'='yes','2'='no'),
drunk=recode(b1001,'1'='no','2'='yes'),
qurel=recode(b1002,'1'='no','2'='yes'),
relation=recode(b1003,'1'= 'no', '2'='yes'),
desk=recode(b11,'1'='yes','2'='no'),
net=recode(b13,'0'='no','1'='no_net','2'='yes'),
maedu=recode(b06,'1'=0,'2'=6,'3'=9,'4'=12,'5'=12,'6'=12,'7'=15,'8'=16,'9'=19),
faedu=recode(b07,'1'=0,'2'=6,'3'=9,'4'=12,'5'=12,'6'=12,'7'=15,'8'=16,'9'=19),
eduexp=recode(b31,'1'=9,'2'=9,'3'=12,'4'=12,'5'=12,'6'=15,'7'=16,'8'=19,'9'=22,'10'=7),
dialect=recode(b27,'1'="madn",'2'='bt','3'='dia','4'='oth'),
chmwk=recode(b2201,'1'="no",'2'='1t2','3'='3t4','4'='evd'),
chcos=recode(b2202,'1'="no",'2'='1t2','3'='3t4','4'='evd')
)
#rm(list=ls())
stutestpre <- read_dta("E:/data/CEPS/2014-2015/cepsw2studentEN.dta")
stutestpre$ids <- stutestpre$ids %>% formatC(., width=5, flag="0", format="fg")
View(stutest)
stutest <- stutestpre %>%
lapply(unclass) %>%
as.data.frame() %>%
select(ids,w2mat,w2upmat)
#rm(list=ls())
stutestpre <- read_dta("E:/data/CEPS/2014-2015/cepsw2studentEN.dta")
stutestpre$ids <- stutestpre$ids %>% formatC(., width=5, flag="0", format="fg")
stutest <- stutestpre %>%
lapply(unclass) %>%
as.data.frame() %>%
select(ids,w2mat,w2upmat)
classpre <- read_dta("E:/data/CEPS/2013-2014/cepsw1teacherEN.dta")
student$ids <- student$ids %>% formatC(., width=5, flag="0", format="fg")
class <- classpre %>%
lapply(unclass) %>%
as.data.frame() %>%
select(clsids, schids,hrb06,hra07,hra08,hra09,hra01, hrb02, hrb08a, hrb08b) %>%
rename(classtm=hra07,clpre=hra08,revitm=hra09,know=hrb02) %>%
mutate(subject=recode(hra01,'0'='oth','1'='mat','2'='lit','3'='eng'),
drsmok=recode(hrb06,'1'='no','2'='yes','3'='yes','4'='yes'),
commhr=hrb08a+hrb08b/60,
know=as.factor(know)
)
schoolpre <- read_dta("E:/data/CEPS/2013-2014/cepsw1principalEN.dta")
school <- schoolpre %>%
lapply(unclass) %>%
as.data.frame() %>%
select(schids, pla01, pla13, pla16, pla17, pla18, plc0102, ple1101, ple1102, ple1103, ple1104, plc0601) %>%
rename(schcsrm=pla13,comno = pla16,buget = pla18,eduqua=plc0102,teainc=plc0601) %>%
mutate(schtype=recode(pla01,'1'='public','2'='oth','3'='oth','4'='oth'),
fight=recode(ple1101,'1'='no','3'='yes','4'='yes'),
brkpb=recode(ple1102,'1'='no','2'='yes','3'='yes','4'='yes'),
bknum=replace(pla17,pla17>40000,NA),
smok=recode(ple1103,'1'='no','2'='yes','3'='yes','4'='yes'),
drink=recode(ple1104,'1'='no','2'='yes','3'='yes'),
)
parentpre <- read_dta("E:/data/CEPS/2013-2014/cepsw1parentEN.dta")
parentpre$ids <- parentpre$ids %>% formatC(., width=5, flag="0", format="fg")
parent <- parentpre %>%
lapply(unclass) %>%
as.data.frame() %>%
select(ids,ba06,ba03, ba05, ba13, ba15, ba16, ba18, ba21, bd05, be07, be06, be24) %>%
mutate(qianzi=as.factor(ba05),
futcfd=as.factor(ba21),
dial=recode(ba15,'1'='madn','2'='bt','3'='dia','4'='oth'),
chidia=recode(ba16,'1'='madn','2'='bt','3'='dia','4'='oth'),
eduyexp=recode(ba18,'1'=9,'2'=9,'3'=12,'4'=12,'5'=12,'6'=15,'7'=16,'8'=19,'9'=22,'10'=7),
huko=recode(bd05,'1'='agr','2'='non','3'='oth','4'='oth'),
eduy=recode(be07,'1'=0,'2'=6,'3'=9,'4'=12,'5'=12,'6'=12,'7'=15,'8'=16,'9'=19),
dangy=recode(be06,'1'='yes','2'='no','2'='no'),
houspro=recode(be24,'1'='yes','2'='no'),
lifetm=replace(ba13,ba13>15,NA),
clfee=replace(ba03,ba03>10000,NA),
money=replace(ba06,ba06>250,NA)
)
ceps <- left_join(stu,parent,by="ids") %>%
left_join(.,class,by="clsids",copy=T, suffix = c("", " ")) %>%
left_join(.,school,by="schids",copy=T)
cepstest <- left_join(ceps,stutest,by="ids")
ceps %>% mutate(math=ifelse(tr_mat>100,tr_mat/150,   ))
