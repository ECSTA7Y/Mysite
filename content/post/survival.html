---
title: '生存分析云笔记'
date: '2019-05-23'
slug: survival
output:
  bookdown::html_document2:
    toc: true
    theme: readable
---



<p><img src="https://img.shields.io/badge/License-CC%20BY--NC--ND%204.0-brightgreen.svg" /></p>
<p>本文系复旦大学人口学系<a href="http://www.ssdpp.fudan.edu.cn/portal/1e2812ee711c4175a3304c7dbc7071e0/70VhqG.html">张震</a>老师和华东师范大学人口研究所<a href="https://faculty.ecnu.edu.cn/s/2160/main.jspy">李强</a>老师的数据分析课程笔记。</p>
<p>一个R生存分析应用的介绍网页<a href="https://rviews.rstudio.com/2017/09/25/survival-analysis-with-r/">Survival Analysis with R</a></p>
<p>生存分析应用：<a href="https://mp.weixin.qq.com/s/XrL2CmoxmJwdvnUDMMYT6w">移动通讯运营商的用户流失问题分析</a></p>
<p>两篇中文文献：</p>
<p>李强, 张震. (2009). 生存分析中时间变量的选择[J]. 中国人口科学(6), 88-95.</p>
<p>李强, 徐刚, 陈丽梅.(2019) 生存分析的应用误区[J]. 中国人口科学(01):101-112.</p>
<hr />
<div id="基本概念" class="section level1">
<h1>基本概念</h1>
<ul>
<li>社会调查只能观察到状态。人口学关心从一个状态到另一个状态转移的风险。试想每一种状态是一个格子，格子内部是人口频数。人口学能通过数频数的方式估计状态转移的风险。<strong>在一个状态内待的时间和风险有着密切的关系</strong>。</li>
</ul>
<p><span class="math inline">\(T\)</span>为随机变量，上帝也不知道</p>
<p>生存函数：<span class="math inline">\(S(t) = P(T &gt; t)\)</span>。是存活概率也是存活百分比。</p>
<p>失效函数(Failure Function)：<span class="math inline">\(F(t)\)</span>,<span class="math inline">\(S(t) = 1 - F(t)\)</span>, <span class="math inline">\(F(t)\)</span>是T的累积分布函数。</p>
<p><span class="math inline">\(f(t) = \frac{{dF(t)}}{{dt}}\)</span>，即<span class="math inline">\(S(t)\)</span>的斜率。等价于生存时间的概率密度函数(直方图)。是无条件的风险。</p>
<p>风险函数: <span class="math display">\[h(t) = \mathop {\lim }\limits_{\Delta t \to 0} \frac{{P(t \le T &lt; t + \Delta t|T \ge t)}}{{\Delta t}},0 &lt; h(t) &lt;  + \infty \]</span></p>
<p><span class="math inline">\(h(t)\)</span>不是密度也不是概率。</p>
<ul>
<li><p>censor(删截): 知道事件发生，但不知道事件何时发生。事件观测期内无法观测。</p></li>
<li><p>truncate(截平): 只有在给定观测期内的个体才会被观测到的状况。样本选择问题。生存函数对应于某种条件概率。</p>
<ul>
<li>censor涉及到事件，truncate涉及到暴露量。</li>
</ul></li>
<li><p>能活到预期寿命者总是62%</p></li>
</ul>
<hr />
<p><a href="https://cmdlinetips.com/2019/03/introduction-to-maximum-likelihood-estimation-in-r/" class="uri">https://cmdlinetips.com/2019/03/introduction-to-maximum-likelihood-estimation-in-r/</a></p>
</div>
<div id="最大似然估计mle" class="section level1">
<h1>最大似然估计(MLE)</h1>
<p>Cox回归避开了模型分布假定的问题。</p>
<ul>
<li><p>假定数据独立同分布。</p>
<p>似然函数：</p></li>
</ul>
<p><span class="math display">\[{\rm{L}}(\lambda ){\rm{ = }}\prod\limits_{i = 1}^\pi  {P(T = t)}  = \prod {f({t_i})}\]</span><br />
<span class="math inline">\(\delta\)</span>是积分小区间</p>
<p><span class="math display">\[P(T = t) \approx 2\delta f(t)\]</span></p>
<ul>
<li>发生风险率(Occurrence-exposure rate)
<span class="math display">\[\widehat \lambda  = \frac{1}{{\bar t }} = \frac{n}{{\sum\limits_{}^{} {{t_i}} }}\]</span>
<span class="math inline">\(\sum\limits_{}^{} {{t_i}}\)</span>是历险人年数。<span class="math inline">\(n\)</span>是事件发生数。<br />
<span class="math inline">\(\lambda\)</span>是个概率估计。</li>
</ul>
<p>求解参数问题是以对数似然函数为目标函数的最优化问题，下面</p>
<pre class="r"><code>library(survival)
library(haven) 
library(ggplot2)
library(dplyr)
library(ggfortify)
library(survminer)
library(rpart)
library(rpart.plot)
library(stats4)
# 简单的一维MLE
y = rpois(n=10000, lambda=7) # 人造一个泊松分布，10000个数据
df_Poisson = data.frame(data=y)  # 变成数据框
nrow(df_Poisson) # 行数
#&gt; [1] 10000
#df_Poisson 
df_Poisson %&gt;%  # 画直方图
  ggplot(aes(data)) + 
  geom_histogram(col=&#39;black&#39;, fill = &#39;white&#39;)+
  labs(title = &#39;Poisson Distribution: rpois(10000,7)&#39;, 
       x = &#39;Count&#39;, y = &#39;data&#39;) +
  theme_bw()</code></pre>
<p><img src="/post/survival_files/figure-html/unnamed-chunk-2-1.png" width="90%" style="display: block; margin: auto;" /></p>
<pre class="r"><code>
log_sum_density = function(lambda,y){ # 累加数据框的对数密度
   llh = sum(dpois(df_Poisson$data,lambda, log=T))
   return(llh)
}

lambdas = seq(1,15, by=0.2) # 生成1-15的lambdas
ll = sapply(lambdas,log_sum_density) 
 
# save the lambdas and log-likelihoods in a data frame
df = data.frame(`likelihood` = ll, lambda=lambdas)

df %&gt;% 
  ggplot(aes(lambda,likelihood))+
  geom_point(size = 4,color = &#39;dodgerblue&#39;)+
  labs(x = &#39;Lambda&#39;,y = &#39;Log Likelihood&#39;) +
  theme_bw(base_size = 16) +
  geom_vline(xintercept = lambdas[which.max(df$likelihood)],
             color=&#39;red&#39;,size=2)</code></pre>
<p><img src="/post/survival_files/figure-html/unnamed-chunk-2-2.png" width="90%" style="display: block; margin: auto;" /></p>
<pre class="r"><code>
log_sum_density0 = function(lambda){ 
   -sum(dpois(df_Poisson$data, lambda, log = T)) 
}

fit0 = mle(log_sum_density0, start = list(lambda = 1),# 使用最大似然法估计参数
           nobs = nrow(df_Poisson))
fit0
#&gt; 
#&gt; Call:
#&gt; mle(minuslogl = log_sum_density0, start = list(lambda = 1), nobs = nrow(df_Poisson))
#&gt; 
#&gt; Coefficients:
#&gt;   lambda 
#&gt; 7.018077
summary(fit0)
#&gt; Maximum likelihood estimation
#&gt; 
#&gt; Call:
#&gt; mle(minuslogl = log_sum_density0, start = list(lambda = 1), nobs = nrow(df_Poisson))
#&gt; 
#&gt; Coefficients:
#&gt;        Estimate Std. Error
#&gt; lambda 7.018077  0.0264918
#&gt; 
#&gt; -2 log L: 47526.32</code></pre>
<div id="删截censored样本的似然函数" class="section level3">
<h3>删截(Censored)样本的似然函数</h3>
<ul>
<li>完全样本的似然函数是在该时点t的密度函数<span class="math inline">\(f({t_i})\)</span>。右删截数据是生存函数<span class="math inline">\(S({C_r})\)</span>。左删截数据为累计分布函数<span class="math inline">\(1 - S({C_l})\)</span>。区间删截为在该时段内的发生概率<span class="math inline">\(S(L) - S(R)\)</span>。</li>
</ul>
<p>右删截：
<span class="math display">\[P({t_i} &gt; 40) = S(40)\]</span></p>
<ul>
<li>40岁删截</li>
</ul>
<p><span class="math display">\[L(\lambda ) = \prod\limits_{observed} {f({t_i})}  \cdot \prod\limits_{censored} {S(40)}\]</span></p>
<p>Assume the first <span class="math inline">\(d\)</span> individuals died, <span class="math inline">\((n-d)\)</span> ware alive at 40:</p>
<p><span class="math display">\[\hat \lambda  = \frac{d}{{\sum {{t_i} - (n - d) \cdot 40} }}\]</span></p>
<p>分子为事件发生数。</p>
<p>人口学、医学中最多的情况是left-truncated &amp; right-cencored(LT-RC)数据。</p>
<p>非参数模型Aalen’s additive regression model可以替代Cox模型。R的<code>survival</code>包的<code>aareg</code>函数可以进行拟合。</p>
<hr />
</div>
</div>
<div id="生存分析估计" class="section level1">
<h1>生存分析估计</h1>
<p>R生存分析介绍：<a href="http://www.openintro.org/stat/surv.php">survival analysis in R</a></p>
<p>使用<code>?rpart::stagec</code>查看数据</p>
<div id="kaplanmeier-estimator-卡普兰迈耶法" class="section level2">
<h2>Kaplan–Meier estimator | 卡普兰迈耶法</h2>
<p>卡普兰迈耶法又称乘积极限法(Product-Limit Method), 公式如下：</p>
<p><span class="math display">\[{\rm{\hat S}}(t) = \prod\limits_{{t_i} \le t} {(1 - {{\hat q}_i})}  = \prod\limits_{{t_i} \le t} {(1 - {{{d_i}} \over {{n_i}}})}\]</span></p>
<p><span class="math inline">\(n_i\)</span>是在时间<span class="math inline">\(t_i\)</span>中的历险人数，<span class="math inline">\(d_i\)</span>是事件发生数。</p>
<pre class="r"><code>table(stagec$pgstat)
#&gt; 
#&gt;  0  1 
#&gt; 92 54
km = with(stagec, Surv(pgtime, pgstat == 1))
head(km,10) 
#&gt;  [1]  6.1+  9.4+  5.2   3.2   1.9   4.8+  5.8+  7.3+  3.7  15.9+

km_fit = survfit(km ~ 1, stagec)
km_fit 
#&gt; Call: survfit(formula = km ~ 1, data = stagec)
#&gt; 
#&gt;       n  events  median 0.95LCL 0.95UCL 
#&gt;   146.0    54.0      NA     7.7      NA</code></pre>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-5"></span>
<img src="https://i.loli.net/2019/11/13/aKTArE51ROidC7t.jpg" alt="生存函数的Kaplan–Meier estimator是生命表$nPx$列的累乘。" width="90%" />
<p class="caption">
Figure 1: 生存函数的Kaplan–Meier estimator是生命表<span class="math inline">\(nPx\)</span>列的累乘。
</p>
</div>
<pre class="r"><code>summary(km_fit, times = c(0.2*(1:25))) #这个表和生命表等价
#&gt; Call: survfit(formula = km ~ 1, data = stagec)
#&gt; 
#&gt;  time n.risk n.event survival std.err lower 95% CI upper 95% CI
#&gt;   0.2    146       0    1.000 0.00000        1.000        1.000
#&gt;   0.4    144       2    0.986 0.00962        0.968        1.000
#&gt;   0.6    143       1    0.979 0.01174        0.957        1.000
#&gt;   0.8    143       0    0.979 0.01174        0.957        1.000
#&gt;   1.0    143       2    0.966 0.01505        0.937        0.996
#&gt;   1.2    139       2    0.952 0.01768        0.918        0.987
#&gt;   1.4    138       1    0.945 0.01883        0.909        0.983
#&gt;   1.6    135       4    0.918 0.02273        0.874        0.963
#&gt;   1.8    132       1    0.911 0.02357        0.866        0.958
#&gt;   2.0    130       3    0.890 0.02589        0.841        0.942
#&gt;   2.2    128       1    0.883 0.02659        0.833        0.937
#&gt;   2.4    126       1    0.876 0.02727        0.825        0.932
#&gt;   2.6    125       3    0.856 0.02916        0.800        0.915
#&gt;   2.8    122       1    0.849 0.02974        0.792        0.909
#&gt;   3.0    120       3    0.828 0.03135        0.769        0.892
#&gt;   3.2    118       2    0.814 0.03235        0.753        0.880
#&gt;   3.4    111       4    0.786 0.03414        0.722        0.856
#&gt;   3.6    111       0    0.786 0.03414        0.722        0.856
#&gt;   3.8    106       3    0.764 0.03538        0.698        0.837
#&gt;   4.0    106       0    0.764 0.03538        0.698        0.837
#&gt;   4.2    105       2    0.750 0.03615        0.682        0.824
#&gt;   4.4    103       1    0.743 0.03653        0.674        0.818
#&gt;   4.6    101       0    0.743 0.03653        0.674        0.818
#&gt;   4.8     97       2    0.728 0.03727        0.658        0.805
#&gt;   5.0     94       1    0.720 0.03763        0.650        0.798</code></pre>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-7"></span>
<img src="https://i.loli.net/2019/11/13/sy7eklhjXZBLrTM.jpg" alt="生命表示例" width="90%" />
<p class="caption">
Figure 2: 生命表示例
</p>
</div>
<pre class="r"><code>kme = survfit(Surv(pgtime, pgstat) ~ 1,stagec)
autoplot(kme, surv.colour = &#39;orange&#39;, censor.colour = &#39;red&#39;)</code></pre>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-81"></span>
<img src="/post/survival_files/figure-html/unnamed-chunk-8-1.png" alt="Kaplan Meier Survival Curve" width="90%" />
<p class="caption">
Figure 3: Kaplan Meier Survival Curve
</p>
</div>
<pre class="r"><code>
km_trt_fit = survfit(Surv(pgtime, pgstat) ~ grade,stagec)
autoplot(km_trt_fit)  </code></pre>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-82"></span>
<img src="/post/survival_files/figure-html/unnamed-chunk-8-2.png" alt="Kaplan Meier Survival Curve" width="90%" />
<p class="caption">
Figure 4: Kaplan Meier Survival Curve
</p>
</div>
</div>
<div id="cox比例风险模型" class="section level2">
<h2>Cox比例风险模型</h2>
<p><span class="math display">\[\ln{h_i}(t) = \ln {h_0}(t) + {\beta _1}{X_1} + {\beta _2}{X_2} +  \cdot  \cdot  \cdot  + {\beta _p}{X_p}\]</span></p>
<ul>
<li><span class="math inline">\({h_i}(t)\)</span>是个体i在时间t时的风险值。<span class="math inline">\({h_0}(t)\)</span>是所有个体在时间t时的非参数风险函数值。<span class="math inline">\({\beta_p}{X_p}\)</span>是对个体i的解释变量和系数。</li>
</ul>
<p><span class="math display">\[{{h(t|{X_i})} \over {h(t|{X_j})}} = {{{h_0}(t)\exp (X_i^T\beta )} \over {{h_0}(t)\exp (X_j^T\beta )}} = \exp [(X_i^T - X_j^T)\beta ]\]</span></p>
<ul>
<li><p>两个分别具有协变量<span class="math inline">\({X_i}\)</span>和<span class="math inline">\({X_j}\)</span>的个体，其风险函数之比为相对危险度（risk ration，RR）或风险比（hazard ration，HR）</p></li>
<li><p><span class="math inline">\({h_i}(t)\)</span>和<span class="math inline">\({h_0}(t)\)</span>随时间变化。在满足比例风险假定后，不同特征样本的风险比（hazard ration，HR）不随时间变化。所以系数是固定的。无时变变量的Cox模型为宽数据(wide data)。</p></li>
</ul>
<pre class="r"><code>coxreg = coxph(Surv(pgtime , pgstat)~age + eet + g2 + grade + gleason + ploidy,stagec)
summary(coxreg)
#&gt; Call:
#&gt; coxph(formula = Surv(pgtime, pgstat) ~ age + eet + g2 + grade + 
#&gt;     gleason + ploidy, data = stagec)
#&gt; 
#&gt;   n= 134, number of events= 49 
#&gt;    (12 observations deleted due to missingness)
#&gt; 
#&gt;                      coef exp(coef) se(coef)      z Pr(&gt;|z|)   
#&gt; age              -0.01859   0.98158  0.02899 -0.641  0.52139   
#&gt; eet               0.09073   1.09498  0.37418  0.242  0.80840   
#&gt; g2               -0.05569   0.94583  0.02664 -2.091  0.03654 * 
#&gt; grade             1.37745   3.96478  0.43615  3.158  0.00159 **
#&gt; gleason           0.21023   1.23397  0.17099  1.230  0.21887   
#&gt; ploidytetraploid  0.98917   2.68901  0.42622  2.321  0.02030 * 
#&gt; ploidyaneuploid   1.22007   3.38742  0.66723  1.829  0.06747 . 
#&gt; ---
#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
#&gt; 
#&gt;                  exp(coef) exp(-coef) lower .95 upper .95
#&gt; age                 0.9816     1.0188    0.9274    1.0390
#&gt; eet                 1.0950     0.9133    0.5259    2.2799
#&gt; g2                  0.9458     1.0573    0.8977    0.9965
#&gt; grade               3.9648     0.2522    1.6864    9.3212
#&gt; gleason             1.2340     0.8104    0.8826    1.7252
#&gt; ploidytetraploid    2.6890     0.3719    1.1663    6.2000
#&gt; ploidyaneuploid     3.3874     0.2952    0.9161   12.5261
#&gt; 
#&gt; Concordance= 0.777  (se = 0.032 )
#&gt; Likelihood ratio test= 47.93  on 7 df,   p=4e-08
#&gt; Wald test            = 40.97  on 7 df,   p=8e-07
#&gt; Score (logrank) test = 47.66  on 7 df,   p=4e-08
coxreg
#&gt; Call:
#&gt; coxph(formula = Surv(pgtime, pgstat) ~ age + eet + g2 + grade + 
#&gt;     gleason + ploidy, data = stagec)
#&gt; 
#&gt;                      coef exp(coef) se(coef)      z       p
#&gt; age              -0.01859   0.98158  0.02899 -0.641 0.52139
#&gt; eet               0.09073   1.09498  0.37418  0.242 0.80840
#&gt; g2               -0.05569   0.94583  0.02664 -2.091 0.03654
#&gt; grade             1.37745   3.96478  0.43615  3.158 0.00159
#&gt; gleason           0.21023   1.23397  0.17099  1.230 0.21887
#&gt; ploidytetraploid  0.98917   2.68901  0.42622  2.321 0.02030
#&gt; ploidyaneuploid   1.22007   3.38742  0.66723  1.829 0.06747
#&gt; 
#&gt; Likelihood ratio test=47.93  on 7 df, p=3.67e-08
#&gt; n= 134, number of events= 49 
#&gt;    (12 observations deleted due to missingness)

ggforest(coxreg,stagec)</code></pre>
<p><img src="/post/survival_files/figure-html/unnamed-chunk-9-1.png" width="90%" style="display: block; margin: auto;" /></p>
<!---
[生存模型的C-index（C指数）](https://blog.csdn.net/fjsd155/article/details/84669331)

[C-index/C-statistic 计算的5种不同方法及比较](https://blog.csdn.net/anshiquanshu/article/details/53438438)
--->
</div>
<div id="aalens-additive-regression-model" class="section level2">
<h2><a href="http://www.medicine.mcgill.ca/epidemiology/hanley/bios601/Encyclopedia%20of%20Biostatistics2ndEd2005.pdf">Aalen’s additive regression model</a></h2>
<pre class="r"><code>aaregfit = aareg(Surv(pgtime, pgstat)~age + eet + g2 + grade + gleason + ploidy,stagec)
aaregfit
#&gt; Call:
#&gt; aareg(formula = Surv(pgtime, pgstat) ~ age + eet + g2 + grade + 
#&gt;     gleason + ploidy, data = stagec)
#&gt; 
#&gt;   n=134 (12 observations deleted due to missingness)
#&gt;     38 out of 38 unique event times used
#&gt; 
#&gt;                     slope      coef se(coef)      z       p
#&gt; Intercept        -0.16500 -0.008530 0.022600 -0.377 0.70600
#&gt; age              -0.00230 -0.000206 0.000312 -0.660 0.50900
#&gt; eet              -0.01000 -0.001460 0.003910 -0.374 0.70900
#&gt; g2               -0.00598 -0.000649 0.000246 -2.640 0.00832
#&gt; grade             0.12200  0.010800 0.004560  2.380 0.01740
#&gt; gleason           0.02260  0.001750 0.002250  0.780 0.43500
#&gt; ploidytetraploid  0.09670  0.010700 0.004330  2.480 0.01320
#&gt; ploidyaneuploid   0.37900  0.021700 0.019900  1.090 0.27400
#&gt; 
#&gt; Chisq=29.68 on 7 df, p=0.000109; test weights=aalen

#ggforest(aaregfit,stagec)
autoplot(aaregfit)</code></pre>
<div class="figure" style="text-align: center">
<img src="/post/survival_files/figure-html/unnamed-chunk-11-1.png" alt=" " width="90%" />
<p class="caption">
</p>
</div>
</div>
<div id="cart树生存分析" class="section level2">
<h2>CART树生存分析</h2>
<pre class="r"><code>fit = rpart(Surv(pgtime , pgstat)~age +
eet + g2 + grade + gleason + ploidy,stagec,method=&#39;exp&#39;)
fit
#&gt; n= 146 
#&gt; 
#&gt; node), split, n, deviance, yval
#&gt;       * denotes terminal node
#&gt; 
#&gt;  1) root 146 192.111100 1.0000000  
#&gt;    2) grade&lt; 2.5 61  44.799010 0.3634439  
#&gt;      4) g2&lt; 11.36 33   9.117405 0.1229835 *
#&gt;      5) g2&gt;=11.36 28  27.602190 0.7345610  
#&gt;       10) gleason&lt; 5.5 20  14.297110 0.5304115 *
#&gt;       11) gleason&gt;=5.5 8  11.094650 1.3069940 *
#&gt;    3) grade&gt;=2.5 85 122.441500 1.6148600  
#&gt;      6) age&gt;=56.5 75 103.062900 1.4255040  
#&gt;       12) gleason&lt; 7.5 50  66.119800 1.1407320  
#&gt;         24) g2&lt; 13.475 24  27.197170 0.8007306 *
#&gt;         25) g2&gt;=13.475 26  36.790960 1.4570210  
#&gt;           50) g2&gt;=17.915 15  20.332740 0.9789825 *
#&gt;           51) g2&lt; 17.915 11  13.459010 2.1714480 *
#&gt;       13) gleason&gt;=7.5 25  33.487250 2.0307290  
#&gt;         26) g2&gt;=15.29 10  11.588480 1.2156230 *
#&gt;         27) g2&lt; 15.29 15  18.939150 2.7053610 *
#&gt;      7) age&lt; 56.5 10  13.769010 3.1822320 *
rpart.plot(fit,shadow.col = &#39;gray&#39;,branch = 0.4)</code></pre>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-12"></span>
<img src="/post/survival_files/figure-html/unnamed-chunk-12-1.png" alt="CART树剪枝前" width="90%" />
<p class="caption">
Figure 5: CART树剪枝前
</p>
</div>
<pre class="r"><code>fit2 = prune(fit, cp = 0.017)
fit2$cptable
#&gt;           CP nsplit rel error    xerror       xstd
#&gt; 1 0.12945955      0 1.0000000 1.0083688 0.07022542
#&gt; 2 0.04205598      1 0.8705405 0.8892725 0.07380900
#&gt; 3 0.02919986      2 0.8284845 0.9072099 0.07757807
#&gt; 4 0.01798864      3 0.7992846 0.9607955 0.08987181
#&gt; 5 0.01700000      4 0.7812960 0.9682238 0.09234577
rpart.plot(fit2,shadow.col = &#39;gray&#39;,branch = 0.4)</code></pre>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-13"></span>
<img src="/post/survival_files/figure-html/unnamed-chunk-13-1.png" alt="CART树剪枝后" width="90%" />
<p class="caption">
Figure 6: CART树剪枝后
</p>
</div>
<pre class="r"><code>temp = snip.rpart(fit2,6)
km = survfit(Surv(pgtime, pgstat) ~ temp$where, stagec)
autoplot(km)</code></pre>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-14"></span>
<img src="/post/survival_files/figure-html/unnamed-chunk-14-1.png" alt="每个结点患者的生存风险估计" width="90%" />
<p class="caption">
Figure 7: 每个结点患者的生存风险估计
</p>
</div>
<pre class="r"><code>ggplot(stagec)+
  geom_point(aes(age,g2,shape=factor(pgstat),
                 col=factor(pgstat)))+
  facet_wrap(~grade)</code></pre>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-15"></span>
<img src="/post/survival_files/figure-html/unnamed-chunk-15-1.png" alt="年龄、G2阶段的瘤细胞比例、肿瘤等级grade的关系" width="90%" />
<p class="caption">
Figure 8: 年龄、G2阶段的瘤细胞比例、肿瘤等级grade的关系
</p>
</div>
<!---
>   这是一个引用的地方这是一个引用的地方这是一个引用的地方这是一个引用的地方这是一个引用的地方
--->
</div>
</div>
