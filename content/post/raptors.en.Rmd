---
title: '2018-2019 NBA Champion Toronto Raptors Analysis'
author: ''
date: '2019-10-30'
output:
  bookdown::html_document2:
    toc: true
    theme: readable
slug: raptors
---

![](https://img.shields.io/badge/License-CC%20BY--NC--ND%204.0-brightgreen.svg)

Toronto Raptors won the 2018-2019 NBA Championship, which is really exciting. I watched the playoffs even months after the season was over. As a data analyst, I find [datas](https://stats.nba.com/) of Raptors and did this analysis. Since tree methods could apperantly display the relations between the feature variables and the response variable, it is appropriate to use them to reveal the factors of wining.

```{r,include=F}
knitr::opts_chunk$set(comment=NA,error=T,message = F,warning = F,fig.align='center',out.width ='100%')
```

```{r,echo=F,fig.cap='Kawhi Leonard versus KD, who was injured during G5'}
#knitr::include_graphics('/img/vignette/raptors.jpg')
```

```{r}
library(readr)
library(dplyr)
library(tidyr)
library(magrittr)
library(party)
library(rpart)
library(rpart.plot)
library(ggplot2)
library(corrplot)
```

```{r,include=F,echo=F}
raptorsplayoffs <- read_csv("E:/MaLearning/nba/raptorsplayoffs.csv")
raptorsreg <- read_csv("E:/MaLearning/nba/raptors_regulars.csv")
raptors_players <- read_csv("E:/MaLearning/nba/raptors_players.csv")
regular_players <- read_csv("E:/MaLearning/nba/regular_players.csv")
```


```{r}
players <- regular_players %>% 
  na_if('-') %>%
  filter(PLAYER!='Jodie Meeks',PLAYER!= 'Eric Moreland',
         PLAYER!='Jonas Valanciunas',PLAYER!='Jordan Loyd',
         PLAYER!='Malcolm Miller',PLAYER!='Chris Boucher',
         PLAYER!='Jeremy Lin',PLAYER!='Lorenzo Brown',
         PLAYER!='Malachi Richardson',PLAYER!='Marc Gasol',
         PLAYER!='Patrick McCaw',PLAYER!='Greg Monroe',
         PLAYER!='CJ Miles') %>% 
  rename('TPP'='3P%','FTP'='FT%',
         'FGP'='FG%','win'='W/L') %>% 
  mutate_if(sapply(.,is.character),as.factor) %>% 
  select(-'+/-') %>% 
  gather(key,value,-TEAM,-MATCHUP,-DATE,-PLAYER,-win) %>% # long to wide
  unite(col, key,PLAYER) %>%
  spread(col,value) %>% 
  select(-TEAM,-MATCHUP,-DATE) %>%
  replace(is.na(.),0) %>% 
  mutate_if(sapply(.,is.character),as.numeric)
ncol(players)
```

```{r}
head(data.frame(players)[1:5])
tree <- ctree(win~.,players,
              controls = ctree_control(mincriterion = 0.00001,minsplit=9))
plot(tree)

treept <- rpart(win~.,players,
                control = rpart.control(cp=0.0001,minsplit=6))

rpart.plot(treept, branch = 0.4)

players %>% 
  rename('TPP_Kyle_Lowry'='TPP_Kyle Lowry',
         'MIN_Pascal_Siakam'='MIN_Pascal Siakam',
         'MIN_Kawhi_Leonard'='MIN_Kawhi Leonard') %>% 
ggplot() +
  geom_point(aes(TPP_Kyle_Lowry,MIN_Pascal_Siakam,shape=win,col=win))

players %>% 
  rename('TPP_Kyle_Lowry'='TPP_Kyle Lowry',
         'MIN_Pascal_Siakam'='MIN_Pascal Siakam',
         'PTS_Kawhi_Leonard'='PTS_Kawhi Leonard') %>% 
ggplot(.,aes(win,PTS_Kawhi_Leonard))+
  geom_boxplot()
```

From the tree, Kyle Lowry's 3 points accuracy is really important for win. It is surprise that Kawhi Leonard does not appear on the tree. It is opporiate to our common sense. It does not mean that Leonard is not significant, as a superstar, he really helps when pivotal time comes, and that contribution might not be reflected from models.

# Playoffs

```{r}
playoffs <- raptorsplayoffs %>% 
  arrange(DATE) %>% 
  na_if('-') %>% 
  rename('TPP'='3P%','FTP'='FT%',
         'FGP'='FG%','win'='W/L') %>% 
  mutate_if(sapply(.,is.character),as.factor) 

formula <- win~PTS+FGM+FGA+FTM+FTA+OREB+DREB+REB+AST+STL+BLK+TOV+PF+FTP+TPP+FGP

tree <- ctree(formula,playoffs,
              controls = ctree_control(mincriterion = 0.01,minsplit=3))

plot(tree)

treept <- rpart(formula,playoffs,
                control = rpart.control(cp=0.001,minsplit=3))
rpart.plot(treept, branch = 0.4)
```

+ Since the quantity of playoff data is too small, the results of the trees are unstable. Even discrepencies between the `rpart` and `ctree` function are huge. Now let us analyze the Regular Season data, which contains 82 games.

# Regular Season

+ Now we begin to analyze raptors' collective data.

```{r,fig.cap='The tree using `party` package.'}
regular<- raptorsreg %>% 
  arrange(DATE) %>% 
  na_if('-') %>% 
  rename('TPP'='3P%','FTP'='FT%',
         'FGP'='FG%','win'='W/L') %>%
  mutate_if(sapply(.,is.character),as.factor)

corrplot(cor(regular %>% 
               select(., PTS:PF), 
             use = 'complete.obs'), 
         method = 'circle')

tree <- ctree(formula,regular,
              controls = ctree_control(mincriterion = 0.01,minsplit=3))
#plot(tree)
plot(tree,type = "simple")
```

```{r,fig.cap='When raptors score more than 111 and the field goals attempted more than 81, they will win in a high chance. If they get less than 111 points and shoot more than 82 times, they will definitely lose.'}
treept <- rpart(formula,regular,
                control = rpart.control(cp=0.05,minsplit=3))

rpart.plot(treept, branch = 0.4)
```

As you could see, the two trees are much same than before.


```{r,fig.cap='Partition borders of the CART tree.'}
ggplot(regular)+
  geom_point(aes(PTS,FGA,
                 shape=win,col=win)) +
  geom_segment(aes(111,81,
                   xend = 111,yend = 110),
               col='purple') +
  geom_segment(aes(111,81,
                   xend = 141,yend = 81),
               col='purple')+
  annotate('text', x =130,y=95, label='Win', size=10,color='turquoise4') +
  annotate('text', x =95,y=85, label='Lose', size=10,color='tomato') +
  labs(x='Points',y='Field Goals Attempted')
```

# Combine collective data and players' personal data

```{r}
players <- regular_players %>% 
  na_if('-') %>%
  filter(PLAYER!='Jodie Meeks',PLAYER!= 'Eric Moreland',
         PLAYER!='Jonas Valanciunas',PLAYER!='Jordan Loyd',
         PLAYER!='Malcolm Miller',PLAYER!='Chris Boucher',
         PLAYER!='Jeremy Lin',PLAYER!='Lorenzo Brown',
         PLAYER!='Malachi Richardson',PLAYER!='Marc Gasol',
         PLAYER!='Patrick McCaw',PLAYER!='Greg Monroe',
         PLAYER!='CJ Miles') %>% 
  rename('TPP'='3P%','FTP'='FT%',
         'FGP'='FG%','win'='W/L') %>% 
  mutate_if(sapply(.,is.character),as.factor) %>% 
  select(-'+/-') %>% 
  gather(key,value,-TEAM,-MATCHUP,-DATE,-PLAYER,-win) %>% # long to wide
  unite(col, key,PLAYER) %>%
  spread(col,value) %>% 
  select(-TEAM,-MATCHUP) %>%
  replace(is.na(.),0) %>% 
  mutate_if(sapply(.,is.character),as.numeric)


intedt <- left_join(regular,players, by ='DATE', suffix = c('','.y')) %>% 
  select(-PTS,-win.y,-TEAM,-DATE,-MATCHUP,-MIN,-'+/-')

tree <- rpart(win~.,intedt,
                control = rpart.control(cp=0.0001,minsplit=6))

rpart.plot(tree, branch = 0.4)
```
PF: personal fouls
