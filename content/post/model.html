---
title: 'R模型可视化'
subtitle: ' '
author: '[宋骁](https://xsong.ltd)'
date: '2019-10-01'
output:
  html_document:
    toc: true
    theme: readable
slug: model
---



<!--
![](https://img.shields.io/badge/License-CC%20BY--NC--ND%204.0-brightgreen.svg)
--->
<p>PDF版本<a href="/modelpdf.pdf">下载</a></p>
<p><a href="https://www.kaggle.com/rikdifos/r-model-visualization-a-r-markdown-report/report">English Version</a></p>
<p>模型可视化是应用统计学的重要内容。任何模型都离不开结果的可视化。所谓<em>模型</em>，不过是将一堆散点简化为一条线。结果的可视化需要预测值。Hadley Wickham的<code>modelr</code>包提供用于预测的函数。预测的结果可以直接被<code>ggplot2</code>使用并画图。<code>modelr</code>支持管道操作，是将数据分析流程化的利器。</p>
<p><code>modelr</code>包的主要函数有：</p>
<p><code>data_grid</code>: 生成预测数据</p>
<p><code>add_predictions</code>: 加入预测值</p>
<p><code>crossv_kfold</code>、<code>crossv_mc</code>、<code>crossv_loo</code>: 交叉验证</p>
<pre class="r"><code>library(dplyr)
library(tidyr)
library(ggplot2)
library(modelr)
library(cowplot)
library(stargazer)
`%&gt;%` &lt;- magrittr::`%&gt;%`</code></pre>
<div id="基础回归" class="section level1">
<h1>基础回归</h1>
<p><code>hatdt</code>为作者个人整理的<a href="http://www.isss.pku.edu.cn/cfps/index.htm">中国家庭追踪调查</a>(CFPS)收入数据<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>。</p>
<pre class="r"><code>library(readr)
hatdt = read_csv(&#39;E:/some_code/capplot/aggregrate.csv&#39;, locale = readr::locale(encoding = &quot;gb18030&quot;))

hatdt &lt;- hatdt %&gt;% 
  filter(`type` == &#39;个人收入（元）&#39;) %&gt;% 
  drop_na(agem,inc,fswt_nat)

set.seed(20191001)
sample &lt;- sample(1:nrow(hatdt),600,replace = F)
sampled &lt;- hatdt[sample,]

plota &lt;- ggplot(hatdt,aes(agem,inc,weight=fswt_nat)) +
  geom_jitter(data=sampled,height=550,width=5,
              size =1.5,alpha=1/3) +
  geom_smooth(span =10,size=1) + 
  geom_smooth(method=&#39;lm&#39;,size=1,color=&#39;red&#39;) +
  ylim(0, 20000) +
  labs(x = &quot;年龄&quot;,y = &quot;人民币(元）&quot;) +
  theme_bw()

plotb &lt;- ggplot() +
  geom_jitter(data=sampled,aes(agem,inc),
              height=550,width=5,size =1.5,alpha=1/3) +
  geom_quantile(data=hatdt,
  aes(agem,inc,weight=fswt_nat),
  size=1,color=&#39;red&#39;)+
  ylim(0, 20000) +
  labs(x = &quot;年龄&quot;,y = &quot;人民币(元）&quot;) +
  theme_bw()</code></pre>
<pre class="r"><code>plot_grid(plota,plotb,ncol = 2)</code></pre>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-4"></span>
<img src="/post/model_files/figure-html/unnamed-chunk-4-1.png" alt="个人收入与年龄。左图：红线为线性回归模型。蓝色曲线为非参数回归。右图：三条线分别是分位数回归。高收入者收入随年龄下降的速度快于低收入者。可将中位数回归与左图线性回归相比较，观测其中的差异。" width="90%" />
<p class="caption">
Figure 1: 个人收入与年龄。左图：红线为线性回归模型。蓝色曲线为非参数回归。右图：三条线分别是分位数回归。高收入者收入随年龄下降的速度快于低收入者。可将中位数回归与左图线性回归相比较，观测其中的差异。
</p>
</div>
</div>
<div id="交互项" class="section level1">
<h1>交互项</h1>
<p>交互项是计量经济学和应用统计学常用的机制分析技术。公式如下：</p>
<p><span class="math display">\[y = {\alpha _0} + {\alpha _1}{x_1} + {\alpha _2}{x_2} + {\alpha _3}{x_1}{x_2}\]</span></p>
<pre class="r"><code>par(mar = c(4,4,1,0.5), mfrow = c(1, 2), cex.main = 1)
sq = 1:10
x = rep(sq, 10)
z = rep(sq, each = 10)
y = c(outer(sq, sq, function(x, z) 2 + x + 0.5 *
z + 0.5 * x * z + runif(1)))
symbols(x, z, y, bg = rgb(0, 1, 0, 0.3), fg = &quot;blue&quot;,
main = &quot;&quot;,
inches = 0.4)
y = c(outer(sq, sq, function(x, z) 2 + x + 0.5 *
z + runif(1)))
symbols(x, z, y, bg = rgb(0, 1, 0, 0.3), fg = &quot;blue&quot;,
main = &quot;&quot;, inches = 0.2)</code></pre>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-5"></span>
<img src="/post/model_files/figure-html/unnamed-chunk-5-1.png" alt="谢益辉的交互效应表示方法。左图：$y = 2 + x + 0.5 z + 0.5 x z + \epsilon$。右图：$y = 2 + x + 0.5 z + \epsilon$。圆圈面积表示因变量$y$的大小；坐标轴分别表示自变量$x$和$z$。" width="90%" />
<p class="caption">
Figure 2: 谢益辉的交互效应表示方法。左图：<span class="math inline">\(y = 2 + x + 0.5 z + 0.5 x z + \epsilon\)</span>。右图：<span class="math inline">\(y = 2 + x + 0.5 z + \epsilon\)</span>。圆圈面积表示因变量<span class="math inline">\(y\)</span>的大小；坐标轴分别表示自变量<span class="math inline">\(x\)</span>和<span class="math inline">\(z\)</span>。
</p>
</div>
<p>下面使用R自带数据，1994年加拿大劳动与收入动态调查(SLID)。详细信息请在R中输入<code>?carData::SLID</code>查看。</p>
<div id="分类变量与连续变量交互" class="section level2">
<h2>分类变量与连续变量交互</h2>
<p>因变量为收入。自变量为教育年限(年)和使用的语言(英语、法语、其他)。下面分别展示了没有交互项和有交互项的模型。</p>
<pre class="r"><code>#?carData::SLID
data(SLID,package = &#39;carData&#39;)
SLID &lt;- SLID %&gt;% drop_na()

mod1 &lt;- lm(wages ~ education + language,SLID)
mod2 &lt;- lm(wages ~ education * language,SLID)

grid &lt;- SLID %&gt;%
data_grid(education,language) %&gt;%
gather_predictions(mod1,mod2)

ggplot(SLID,aes(education,wages))+
  geom_jitter(size=1,width=2,height=10,alpha=1/7)+
  geom_line(data=grid,
            aes(education,pred,color=language),size=1)+
  facet_wrap(~model)+
  xlim(0,25)+ ylim(0,40)+
  theme_bw()</code></pre>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-6"></span>
<img src="/post/model_files/figure-html/unnamed-chunk-6-1.png" alt="左图：语言不与教育年限交互。不同语言使用者的斜率相同但截距不同。右图：交互模型，英语使用者的工资随教育回报率更高，假定其他条件不变。英语使用者在15年处超越了其他语言使用者。" width="90%" />
<p class="caption">
Figure 3: 左图：语言不与教育年限交互。不同语言使用者的斜率相同但截距不同。右图：交互模型，英语使用者的工资随教育回报率更高，假定其他条件不变。英语使用者在15年处超越了其他语言使用者。
</p>
</div>
</div>
<div id="两个连续变量交互" class="section level2">
<h2>两个连续变量交互</h2>
<p>对两个连续交互变量的可视化是一个难题。较好的解决办法是分箱。使用<code>modelr</code>的<code>seq_range</code>函数对其中一个连续变量进行分箱。</p>
<pre class="r"><code>mod1 &lt;- lm(wages ~ education + age,SLID)
mod2 &lt;- lm(wages ~ education * age,SLID)

grid &lt;- SLID %&gt;%
data_grid(education,age = seq_range(age, 5)) %&gt;%
gather_predictions(mod1,mod2)

ggplot(SLID,aes(education,wages))+
  geom_jitter(size=1,width=2,
              height=10,alpha=1/7)+
  geom_line(data=grid,aes(education,pred,
                          color=age,group=age),size=1)+
  facet_wrap(~model)+
  xlim(0,25)+ ylim(0,40)+
  theme_bw()</code></pre>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-7"></span>
<img src="/post/model_files/figure-html/unnamed-chunk-7-1.png" alt="无交互效应和有交互效应的区别： 左图体现了不同年龄段者的教育回报率相同(斜率相同)。右图体现了一个因素的大小随着另一个因素的变化而变化。随着年龄的升高教育回报率也在升高。" width="90%" />
<p class="caption">
Figure 4: 无交互效应和有交互效应的区别： 左图体现了不同年龄段者的教育回报率相同(斜率相同)。右图体现了一个因素的大小随着另一个因素的变化而变化。随着年龄的升高教育回报率也在升高。
</p>
</div>
<p>来个负相关的：</p>
<pre class="r"><code>data(freeny)
partial &lt;- lm(y~lag.quarterly.revenue+price.index+
                income.level+market.potential,freeny)

modela &lt;- lm(y~price.index+market.potential,freeny)
modelb &lt;- lm(y~price.index*market.potential,freeny)

stargazer(modela,modelb,partial,
          title=&#39;回归结果&#39;,
          dep.var.caption=&#39;&#39;,
          dep.var.labels=&#39;Quarterly Revenue&#39;,
          header=F,keep.stat=c(&#39;n&#39;,&#39;rsq&#39;), 
         no.space=T,type=&#39;html&#39;,align=T)</code></pre>
<table style="text-align:center">
<caption>
<strong>回归结果</strong>
</caption>
<tr>
<td colspan="4" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td colspan="3">
Quarterly Revenue
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(1)
</td>
<td>
(2)
</td>
<td>
(3)
</td>
</tr>
<tr>
<td colspan="4" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
lag.quarterly.revenue
</td>
<td>
</td>
<td>
</td>
<td>
0.124
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
</td>
<td>
</td>
<td>
(0.142)
</td>
</tr>
<tr>
<td style="text-align:left">
price.index
</td>
<td>
-0.414<sup>*</sup>
</td>
<td>
-39.796<sup>***</sup>
</td>
<td>
-0.754<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.210)
</td>
<td>
(5.737)
</td>
<td>
(0.161)
</td>
</tr>
<tr>
<td style="text-align:left">
income.level
</td>
<td>
</td>
<td>
</td>
<td>
0.767<sup>***</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
</td>
<td>
</td>
<td>
(0.134)
</td>
</tr>
<tr>
<td style="text-align:left">
market.potential
</td>
<td>
4.030<sup>***</sup>
</td>
<td>
-10.270<sup>***</sup>
</td>
<td>
1.331<sup>**</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(0.434)
</td>
<td>
(2.102)
</td>
<td>
(0.509)
</td>
</tr>
<tr>
<td style="text-align:left">
price.index:market.potential
</td>
<td>
</td>
<td>
2.979<sup>***</sup>
</td>
<td>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
</td>
<td>
(0.434)
</td>
<td>
</td>
</tr>
<tr>
<td style="text-align:left">
Constant
</td>
<td>
-41.499<sup>***</sup>
</td>
<td>
147.459<sup>***</sup>
</td>
<td>
-10.473<sup>*</sup>
</td>
</tr>
<tr>
<td style="text-align:left">
</td>
<td>
(6.602)
</td>
<td>
(27.863)
</td>
<td>
(6.022)
</td>
</tr>
<tr>
<td colspan="4" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
Observations
</td>
<td>
39
</td>
<td>
39
</td>
<td>
39
</td>
</tr>
<tr>
<td style="text-align:left">
R<sup>2</sup>
</td>
<td>
0.994
</td>
<td>
0.997
</td>
<td>
0.998
</td>
</tr>
<tr>
<td colspan="4" style="border-bottom: 1px solid black">
</td>
</tr>
<tr>
<td style="text-align:left">
<em>Note:</em>
</td>
<td colspan="3" style="text-align:right">
<sup><em></sup>p&lt;0.1; <sup><strong></sup>p&lt;0.05; <sup></strong></em></sup>p&lt;0.01
</td>
</tr>
</table>
<pre class="r"><code>gridt &lt;- freeny %&gt;% 
  data_grid(price.index,
            market.potential=
            seq_range(market.potential,5)) %&gt;%
  gather_predictions(modela,modelb)


ggplot(freeny,aes(price.index,y,
                  color=market.potential))+
  geom_point()+
  geom_line(data=gridt,aes(price.index,pred,
color=market.potential,
group=market.potential))+
  facet_wrap(~model)+
  theme_bw()</code></pre>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-8"></span>
<img src="/post/model_files/figure-html/unnamed-chunk-8-1.png" alt="左图无交互效应，可视为控制变量。右图为两个连续变量的交互效应" width="90%" />
<p class="caption">
Figure 5: 左图无交互效应，可视为控制变量。右图为两个连续变量的交互效应
</p>
</div>
</div>
</div>
<div id="多项式回归" class="section level1">
<h1>多项式回归</h1>
<ul>
<li>多项式回归是平滑方法的基础。</li>
</ul>
<p>类似于泰勒公式的思想，即使用多项式函数去拟合光滑函数。</p>
<pre class="r"><code>set.seed(2019)
x &lt;- seq(0,4,length=100)
y &lt;- -x^2 + 3*x + jitter(rep(5:9,each =20),2) +3
df &lt;- data.frame(x,y)

reg &lt;- lm(y ~ x + I(x^2),df)

grid &lt;- df %&gt;%
data_grid(x) %&gt;%
gather_predictions(reg)

ggplot(df,aes(x,y))+
  geom_point(size =2,alpha=1/3)+
  geom_line(data=grid,aes(x,pred),size=1,color=&#39;blue&#39;)+
  theme_bw()</code></pre>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-9"></span>
<img src="/post/model_files/figure-html/unnamed-chunk-9-1.png" alt="对一个模拟数据进行二次项回归。" width="90%" />
<p class="caption">
Figure 6: 对一个模拟数据进行二次项回归。
</p>
</div>
<p>下面使用多项式回归拟合CFPS数据:</p>
<p><span class="math display">\[y = {\alpha _0} + {\alpha _1}{x_1} + {\alpha _2}x_1^2\]</span>
<span class="math display">\[y = {\alpha _0} + {\alpha _1}{x_1} + {\alpha _2}x_1^2 + {\alpha _3}x_1^3\]</span></p>
<pre class="r"><code>mtrga &lt;- lm(inc~agem+I(agem^2),hatdt)
mtrgb &lt;- lm(inc~agem+I(agem^2)+I(agem^3),hatdt)

grid &lt;- hatdt %&gt;%
data_grid(agem) %&gt;%
gather_predictions(mtrga,mtrgb)

ggplot() +
  geom_jitter(data=sampled,aes(agem,inc),
              height=550,width=5,size =1.5,alpha=1/3) +
  geom_line(data=grid,aes(agem,pred),
            size=1,color=&#39;blue&#39;)+
  facet_wrap(~model) +
  ylim(0, 20000) +
  labs(x = &quot;年龄&quot;,y = &quot;人民币(元）&quot;) +
  theme_bw()</code></pre>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-10"></span>
<img src="/post/model_files/figure-html/unnamed-chunk-10-1.png" alt="分别对CFPS数据进行二次项和三次项回归。三次项导致了过拟合。" width="90%" />
<p class="caption">
Figure 7: 分别对CFPS数据进行二次项和三次项回归。三次项导致了过拟合。
</p>
</div>
</div>
<div id="局部加权回归散点平滑" class="section level1">
<h1>局部加权回归散点平滑</h1>
<ul>
<li>Locally Weighted Scatterplot Smoother，LOWESS</li>
</ul>
<p><span class="math display">\[{y_i} = g({x_i}) + {\varepsilon _i}\]</span>
<span class="math inline">\(g\)</span>是在<span class="math inline">\(x\)</span>带宽<span class="math inline">\(\alpha\)</span>范围内进行的多项式回归。</p>
<pre class="r"><code>data(PlantCounts,package = &#39;MSG&#39;)
g &lt;- ggplot(PlantCounts,
            aes(altitude,counts)) +
  geom_point(size=1.5,alpha=1/3) +
  ylim(0,80)+
  theme_bw()

for (i in seq(1,1700,10)){
  col = rgb(0.4,i/1700,0.4)
  g &lt;- g + stat_smooth(geom=&#39;line&#39;,
                       span=i/1000,
                       size=0.6,
                       se=F,color=col)
}

f &lt;- ggplot(PlantCounts,
            aes(altitude, counts)) +
  geom_point(size=1.5,alpha=1/3) +
  ylim(0,80)+
  theme_bw()

for (i in 1:200) {
idx &lt;- sample(nrow(PlantCounts),300,T)
df &lt;- PlantCounts[idx,]
f &lt;- f + stat_smooth(geom=&#39;line&#39;,
                     data=df,
                     aes(altitude,counts),
                     span=1,size=0.5,
                     se=F,alpha=1/10)
}

e &lt;- ggplot(PlantCounts,
            aes(altitude, counts)) +
  geom_point(size=1.5,alpha=1/3) +
  geom_smooth(span=1,size=1)+
  ylim(0,80)+
  theme_bw()
plot_grid(g,f,e,ncol = 2)</code></pre>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-11"></span>
<img src="/post/model_files/figure-html/unnamed-chunk-11-1.png" alt="左图：设置不同带宽进行LOWESS回归。右图：Bootstrap重抽样200次的结果。" width="90%" />
<p class="caption">
Figure 8: 左图：设置不同带宽进行LOWESS回归。右图：Bootstrap重抽样200次的结果。
</p>
</div>
</div>
<div id="样条" class="section level1">
<h1>样条</h1>
<ul>
<li><p>Splines</p></li>
<li><p>结点为<span class="math inline">\(a\)</span>, <span class="math inline">\(b\)</span>, <span class="math inline">\(c\)</span>的样条回归函数为：</p></li>
</ul>
<p><span class="math display">\[y = \alpha  + {\beta _1}x + {\beta _2}{(x - a)_ + } + {\beta _3}{(x - b)_ + } + {\beta _4}{(x - c)_ + }\]</span></p>
<p><span class="math inline">\({(\mu )_ + } = \mu\)</span> 当 <span class="math inline">\(\mu&gt;0\)</span>，否则<span class="math inline">\({(\mu )_ + } = 0\)</span>。</p>
<pre class="r"><code>library(ISLR)
library(splines)
data(wage,package = &#39;ISLR&#39;)
fita &lt;- lm(wage ~ bs(age,degree=1,knots = c(25,40,60)),Wage)
fitb &lt;- lm(wage ~ bs(age,knots = c(25,40,60)),Wage)
summary(fita)</code></pre>
<pre><code>
Call:
lm(formula = wage ~ bs(age, degree = 1, knots = c(25, 40, 60)), 
    data = Wage)

Residuals:
    Min      1Q  Median      3Q     Max 
-99.795 -24.686  -4.856  15.344 204.671 

Coefficients:
                                            Estimate Std. Error t value
(Intercept)                                   54.333      5.957   9.120
bs(age, degree = 1, knots = c(25, 40, 60))1   37.645      6.817   5.522
bs(age, degree = 1, knots = c(25, 40, 60))2   65.847      6.019  10.940
bs(age, degree = 1, knots = c(25, 40, 60))3   63.850      6.319  10.104
bs(age, degree = 1, knots = c(25, 40, 60))4   33.772     10.580   3.192
                                            Pr(&gt;|t|)    
(Intercept)                                  &lt; 2e-16 ***
bs(age, degree = 1, knots = c(25, 40, 60))1 3.64e-08 ***
bs(age, degree = 1, knots = c(25, 40, 60))2  &lt; 2e-16 ***
bs(age, degree = 1, knots = c(25, 40, 60))3  &lt; 2e-16 ***
bs(age, degree = 1, knots = c(25, 40, 60))4  0.00143 ** 
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1

Residual standard error: 39.91 on 2995 degrees of freedom
Multiple R-squared:  0.08665,   Adjusted R-squared:  0.08543 
F-statistic: 71.03 on 4 and 2995 DF,  p-value: &lt; 2.2e-16</code></pre>
<pre class="r"><code>summary(fitb)</code></pre>
<pre><code>
Call:
lm(formula = wage ~ bs(age, knots = c(25, 40, 60)), data = Wage)

Residuals:
    Min      1Q  Median      3Q     Max 
-98.832 -24.537  -5.049  15.209 203.207 

Coefficients:
                                Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)                       60.494      9.460   6.394 1.86e-10 ***
bs(age, knots = c(25, 40, 60))1    3.980     12.538   0.317 0.750899    
bs(age, knots = c(25, 40, 60))2   44.631      9.626   4.636 3.70e-06 ***
bs(age, knots = c(25, 40, 60))3   62.839     10.755   5.843 5.69e-09 ***
bs(age, knots = c(25, 40, 60))4   55.991     10.706   5.230 1.81e-07 ***
bs(age, knots = c(25, 40, 60))5   50.688     14.402   3.520 0.000439 ***
bs(age, knots = c(25, 40, 60))6   16.606     19.126   0.868 0.385338    
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1

Residual standard error: 39.92 on 2993 degrees of freedom
Multiple R-squared:  0.08642,   Adjusted R-squared:  0.08459 
F-statistic: 47.19 on 6 and 2993 DF,  p-value: &lt; 2.2e-16</code></pre>
<pre class="r"><code>grid &lt;- Wage %&gt;% 
  data_grid(age) %&gt;%
  gather_predictions(fita,fitb)

ggplot(Wage,aes(age,wage))+
  geom_point(size=1,alpha=1/7)+
  geom_line(data=grid,aes(age,pred),
            size=1,color=&#39;purple&#39;)+
  facet_wrap(~model)+
  theme_bw()</code></pre>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-12"></span>
<img src="/post/model_files/figure-html/unnamed-chunk-12-1.png" alt="左图：1次项样条。右图：3次项样条" width="100%" />
<p class="caption">
Figure 9: 左图：1次项样条。右图：3次项样条
</p>
</div>
</div>
<div id="广义可加模型" class="section level1">
<h1>广义可加模型</h1>
<p><span class="math display">\[{y_i} = {\beta _0} + {f_1}({x_1}) + {f_2}({x_2}) +  \cdot  \cdot  \cdot  + {f_k}({x_k})\]</span></p>
<p><img src="https://multithreaded.stitchfix.com/assets/images/blog/fig1.svg" width="90%" style="display: block; margin: auto;" /></p>
<pre class="r"><code>library(mgcv)
par(mfrow=c(1,1),mar=c(2,2,2,2))

gamfit &lt;- gam(wages~ s(education)+bs(age, degree = 2, knots = c(20,30,40,55)),data=SLID)
summary(gamfit)</code></pre>
<pre><code>
Family: gaussian 
Link function: identity 

Formula:
wages ~ s(education) + bs(age, degree = 2, knots = c(20, 30, 
    40, 55))

Parametric coefficients:
                                                Estimate Std. Error t value
(Intercept)                                       9.9635     0.8844  11.266
bs(age, degree = 2, knots = c(20, 30, 40, 55))1  -1.9846     1.1801  -1.682
bs(age, degree = 2, knots = c(20, 30, 40, 55))2   1.2099     0.9411   1.286
bs(age, degree = 2, knots = c(20, 30, 40, 55))3   7.6049     0.9651   7.880
bs(age, degree = 2, knots = c(20, 30, 40, 55))4   8.7600     0.9630   9.096
bs(age, degree = 2, knots = c(20, 30, 40, 55))5   8.7637     1.1253   7.788
bs(age, degree = 2, knots = c(20, 30, 40, 55))6   5.0601     1.8398   2.750
                                                Pr(&gt;|t|)    
(Intercept)                                      &lt; 2e-16 ***
bs(age, degree = 2, knots = c(20, 30, 40, 55))1  0.09271 .  
bs(age, degree = 2, knots = c(20, 30, 40, 55))2  0.19869    
bs(age, degree = 2, knots = c(20, 30, 40, 55))3 4.20e-15 ***
bs(age, degree = 2, knots = c(20, 30, 40, 55))4  &lt; 2e-16 ***
bs(age, degree = 2, knots = c(20, 30, 40, 55))5 8.62e-15 ***
bs(age, degree = 2, knots = c(20, 30, 40, 55))6  0.00598 ** 
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1

Approximate significance of smooth terms:
               edf Ref.df     F p-value    
s(education) 5.339  6.439 93.08  &lt;2e-16 ***
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1

R-sq.(adj) =  0.301   Deviance explained = 30.3%
GCV = 43.394  Scale est. = 43.259    n = 3987</code></pre>
<pre class="r"><code>vis.gam(gamfit,color=&#39;terrain&#39;,
        theta=30, phi=30,
        zlab=&#39;Wage&#39;)</code></pre>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-14"></span>
<img src="/post/model_files/figure-html/unnamed-chunk-14-1.png" alt="教育年限，年龄与收入" width="90%" />
<p class="caption">
Figure 10: 教育年限，年龄与收入
</p>
</div>
<pre class="r"><code>SLID &lt;- SLID %&gt;% 
  mutate(lgwage=log1p(wages))
gamfit2 &lt;- gam(lgwage ~ s(education)+ bs(age, degree = 2, knots = c(20,30,40,55)),data = SLID)
summary(gamfit2)</code></pre>
<pre><code>
Family: gaussian 
Link function: identity 

Formula:
lgwage ~ s(education) + bs(age, degree = 2, knots = c(20, 30, 
    40, 55))

Parametric coefficients:
                                                Estimate Std. Error t value
(Intercept)                                      2.20610    0.05091  43.330
bs(age, degree = 2, knots = c(20, 30, 40, 55))1 -0.10426    0.06794  -1.535
bs(age, degree = 2, knots = c(20, 30, 40, 55))2  0.29695    0.05418   5.481
bs(age, degree = 2, knots = c(20, 30, 40, 55))3  0.62907    0.05556  11.322
bs(age, degree = 2, knots = c(20, 30, 40, 55))4  0.68858    0.05544  12.421
bs(age, degree = 2, knots = c(20, 30, 40, 55))5  0.67619    0.06478  10.438
bs(age, degree = 2, knots = c(20, 30, 40, 55))6  0.41298    0.10589   3.900
                                                Pr(&gt;|t|)    
(Intercept)                                      &lt; 2e-16 ***
bs(age, degree = 2, knots = c(20, 30, 40, 55))1    0.125    
bs(age, degree = 2, knots = c(20, 30, 40, 55))2 4.49e-08 ***
bs(age, degree = 2, knots = c(20, 30, 40, 55))3  &lt; 2e-16 ***
bs(age, degree = 2, knots = c(20, 30, 40, 55))4  &lt; 2e-16 ***
bs(age, degree = 2, knots = c(20, 30, 40, 55))5  &lt; 2e-16 ***
bs(age, degree = 2, knots = c(20, 30, 40, 55))6 9.77e-05 ***
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1

Approximate significance of smooth terms:
               edf Ref.df     F p-value    
s(education) 5.398  6.501 73.54  &lt;2e-16 ***
---
Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1

R-sq.(adj) =   0.34   Deviance explained = 34.2%
GCV = 0.14374  Scale est. = 0.14329   n = 3987</code></pre>
<pre class="r"><code>vis.gam(gamfit2,color=&#39;heat&#39;,
        theta=30, phi=30,
        zlab=&#39;log(Wage)&#39;)</code></pre>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-15"></span>
<img src="/post/model_files/figure-html/unnamed-chunk-15-1.png" alt="教育年限，年龄与对数收入" width="90%" />
<p class="caption">
Figure 11: 教育年限，年龄与对数收入
</p>
</div>
</div>
<div id="box-cox-变换" class="section level1">
<h1><a href="http://onlinestatbook.com/2/transformations/box-cox.html">Box-Cox 变换</a></h1>
<p>为保证变量的正态性进行的统计学转换。它同样是Power transform的一种。</p>
<p><span class="math display">\[
{y(\lambda)}=\left\{
\begin{aligned}
{\textstyle{{{y^\lambda } - 1} \over \lambda }} &amp; , &amp; \mbox{if}\quad\lambda\ne 0 \\
\log y &amp; , &amp; \mbox{if}\quad\lambda = 0
\end{aligned}
\right.
\]</span></p>
<p>注意Box-Cox 变换只能应用于正数值。如果数据中有负数<span class="math inline">\(y&lt;0\)</span>, <span class="math inline">\(y\)</span> 会被整体加上一个 <span class="math inline">\(\lambda _2\)</span> 值。如下所示：</p>
<p><span class="math display">\[
{y(\lambda)}=\left\{
\begin{aligned}
{\textstyle{{{{(y + {\lambda _2})}^{{\lambda _1}}} - 1} \over {{\lambda _1}}}} &amp; , &amp; \mbox{if}\quad\lambda_1\ne 0 \\
\log (y + {\lambda _2}{\rm{)}} &amp; , &amp; \mbox{if}\quad\lambda_1 = 0
\end{aligned}
\right.
\]</span></p>
<pre class="r"><code>library(MASS)
x = rf(500,30,30)
result = boxcox(x~1,lambda = seq(-0.5,0,5),
                plotit = F)
mylambda = result$x[which.max(result$y)]
mylambda</code></pre>
<pre><code>[1] -0.5</code></pre>
<pre class="r"><code>x2 &lt;- (x^mylambda-1)/mylambda
x2 = as.data.frame(x2)

ggplot(x2,aes(x2)) +
  geom_density(data=as.data.frame(x),
               aes(x),fill=&#39;purple&#39;,
               col=&#39;purple&#39;,alpha=1/5)+
  geom_density(data=as.data.frame(x2),
               aes(x2),fill=&#39;green&#39;,
               col=&#39;green&#39;,alpha=1/5) +
  labs(x=&#39;&#39;)</code></pre>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-16"></span>
<img src="/post/model_files/figure-html/unnamed-chunk-16-1.png" alt="紫色密度图为原分布；绿色密度图为Box-Cox 变换后的分布" width="90%" />
<p class="caption">
Figure 12: 紫色密度图为原分布；绿色密度图为Box-Cox 变换后的分布
</p>
</div>
<p>Python中的做法：<code>scipy.special.boxcox</code></p>
<pre class="python"><code>import numpy as np
import seaborn as sns
from scipy.stats import f
from scipy.stats import boxcox

r = f.rvs(30, 30, size=500)
np.random.seed(1234) 
transformed,fitted_lambda = boxcox(r)
print(&#39;lambda=&#39;,fitted_lambda)
sns.distplot(r, rug=True,color=&#39;green&#39;)
sns.distplot(transformed, rug=True)</code></pre>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>可从<a href="https://github.com/ECSTA7Y/MaLearning/blob/master/aggregrate.csv">Github</a>下载<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
