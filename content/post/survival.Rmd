---
title: '生存分析云笔记'
date: '2019-05-23'
slug: survival
output:
  bookdown::html_document2:
    toc: true
    theme: readable
---


![](https://img.shields.io/badge/License-CC%20BY--NC--ND%204.0-brightgreen.svg)

本文系复旦大学人口学系[张震](http://www.ssdpp.fudan.edu.cn/portal/1e2812ee711c4175a3304c7dbc7071e0/70VhqG.html)老师和华东师范大学人口研究所[李强](https://faculty.ecnu.edu.cn/s/2160/main.jspy)老师的数据分析课程笔记。

一个R生存分析应用的介绍网页[Survival Analysis with R](https://rviews.rstudio.com/2017/09/25/survival-analysis-with-r/)

生存分析应用：[移动通讯运营商的用户流失问题分析](https://mp.weixin.qq.com/s/XrL2CmoxmJwdvnUDMMYT6w)

两篇中文文献：

李强, 张震. (2009). 生存分析中时间变量的选择[J]. 中国人口科学(6), 88-95.

李强, 徐刚, 陈丽梅.(2019) 生存分析的应用误区[J]. 中国人口科学(01):101-112.

---

# 基本概念

+ 社会调查只能观察到状态。人口学关心从一个状态到另一个状态转移的风险。试想每一种状态是一个格子，格子内部是人口频数。人口学能通过数频数的方式估计状态转移的风险。**在一个状态内待的时间和风险有着密切的关系**。



$T$为随机变量，上帝也不知道

生存函数：$S(t) = P(T > t)$。是存活概率也是存活百分比。

失效函数(Failure Function)：$F(t)$,$S(t) = 1 - F(t)$, $F(t)$是T的累积分布函数。



$f(t) = \frac{{dF(t)}}{{dt}}$，即$S(t)$的斜率。等价于生存时间的概率密度函数(直方图)。是无条件的风险。

风险函数: $$h(t) = \mathop {\lim }\limits_{\Delta t \to 0} \frac{{P(t \le T < t + \Delta t|T \ge t)}}{{\Delta t}},0 < h(t) <  + \infty $$



$h(t)$不是密度也不是概率。


+ censor(删截):   知道事件发生，但不知道事件何时发生。事件观测期内无法观测。
+ truncate(截平):   只有在给定观测期内的个体才会被观测到的状况。样本选择问题。生存函数对应于某种条件概率。

  + censor涉及到事件，truncate涉及到暴露量。

+ 能活到预期寿命者总是62\%

---

<https://cmdlinetips.com/2019/03/introduction-to-maximum-likelihood-estimation-in-r/>

# 最大似然估计(MLE)

 Cox回归避开了模型分布假定的问题。

+ 假定数据独立同分布。

    似然函数：

$${\rm{L}}(\lambda ){\rm{ = }}\prod\limits_{i = 1}^\pi  {P(T = t)}  = \prod {f({t_i})}$$  
$\delta$是积分小区间

$$P(T = t) \approx 2\delta f(t)$$


+ 发生风险率(Occurrence-exposure rate)
$$\widehat \lambda  = \frac{1}{{\bar t }} = \frac{n}{{\sum\limits_{}^{} {{t_i}} }}$$
$\sum\limits_{}^{} {{t_i}}$是历险人年数。$n$是事件发生数。  
 $\lambda$是个概率估计。
 
```{r,include=F}
knitr::opts_chunk$set(comment=NA,error=T,message=F,warning=F,fig.align='center',out.width='90%')
```

```{r}
library(survival)
library(haven) 
library(ggplot2)
library(dplyr)
library(ggfortify)
library(survminer)
library(rpart)
library(rpart.plot)
library(stats4)
```
 
```{r}
y <- rpois(n=10000, lambda=7)
df_Poisson <- data.frame(data=y)
#df_Poisson
df_Poisson %>% 
  ggplot(aes(data))+ 
  geom_histogram() +
  ylab("Count")+ xlab("data")+
  theme_bw(base_size = 16) +
  ggtitle("Poisson Distribution: rpois(10000,7)")

NROW(df_Poisson)

llh_poisson <- function(lambda,y){
  # log(likelihood) by summing 
   llh <- sum(dpois(df_Poisson$data,lambda, log=T))
   return(llh)
}

lambdas <- seq(1,15, by=0.2)
ll <- sapply(lambdas,llh_poisson)
 
# save the lambdas and log-likelihoods in a data frame
df <- data.frame(ll=ll, lambda=lambdas)


df %>% 
  ggplot(aes(lambda,ll))+
  geom_point(size=4,color="dodgerblue")+
  xlab("Lambda") +
  ylab("Log Likelihood")+
  theme_bw(base_size = 16) +
  geom_vline(xintercept = lambdas[which.max(ll)], color="red",size=2)

ll <- function(lambda){
  # log(likelihood) by summing 
   -sum(dpois(df_Poisson$data,lambda, log=T))
}

fit0 <- mle(ll, start = list(lambda = 1), nobs = NROW(df_Poisson))
fit0
summary(fit0)
```


### 删截(Censored)样本的似然函数

+ 完全样本的似然函数是在该时点t的密度函数$f({t_i})$。右删截数据是生存函数$S({C_r})$。左删截数据为累计分布函数$1 - S({C_l})$。区间删截为在该时段内的发生概率$S(L) - S(R)$。

右删截：
$$P({t_i} > 40) = S(40)$$

+ 40岁删截


$$L(\lambda ) = \prod\limits_{observed} {f({t_i})}  \cdot \prod\limits_{censored} {S(40)}$$

Assume the first $d$ individuals died, $(n-d)$ ware alive at 40:

$$\hat \lambda  = \frac{d}{{\sum {{t_i} - (n - d) \cdot 40} }}$$

分子为事件发生数。



人口学、医学中最多的情况是left-truncated & right-cencored(LT-RC)数据。

非参数模型Aalen’s additive regression model可以替代Cox模型。R的`survival`包的`aareg`函数可以进行拟合。

---

# 生存分析估计

R生存分析介绍：[survival analysis in R](http://www.openintro.org/stat/surv.php)



使用`?rpart::stagec`查看数据

```{r,include = F}
#cwg <- read_dta("E:/R_codes/others/cwg.dta")
#变量排序
#cwg$event[cwg$cen_r ==0] <- 1
#cwg$event[cwg$cen_r ==1] <- 0
#cwg$los1 <- cwg$los1/30

#cwg <- select(cwg,cen_r,event, los1,everything())
#head(cwg)#数据
```

## Kaplan–Meier estimator | 卡普兰迈耶法

卡普兰迈耶法又称乘积极限法(Product-Limit Method), 公式如下：

$${\rm{\hat S}}(t) = \prod\limits_{{t_i} \le t} {(1 - {{\hat q}_i})}  = \prod\limits_{{t_i} \le t} {(1 - {{{d_i}} \over {{n_i}}})}$$

$n_i$是在时间$t_i$中的历险人数，$d_i$是事件发生数。

```{r}
table(stagec$pgstat)
km <- with(stagec, Surv(pgtime, pgstat == 1))
head(km,10) 

km_fit <- survfit(km ~ 1, stagec)
km_fit 
```

```{r, echo=F,fig.cap='生存函数的Kaplan–Meier estimator是生命表$nPx$列的累乘。'}
knitr::include_graphics('https://i.loli.net/2019/11/13/aKTArE51ROidC7t.jpg')
```


```{r}
summary(km_fit, times = c(0.2*(1:25))) #这个表和生命表等价
```

```{r, echo=F,fig.cap='生命表示例'}
knitr::include_graphics('https://i.loli.net/2019/11/13/sy7eklhjXZBLrTM.jpg')
```

```{r,fig.cap='Kaplan Meier Survival Curve'}
kme <- survfit(Surv(pgtime, pgstat) ~ 1,stagec)
autoplot(kme, surv.colour = 'orange', censor.colour = 'red')

km_trt_fit <- survfit(Surv(pgtime, pgstat) ~ grade,stagec)
autoplot(km_trt_fit)  
```

## Cox比例风险模型

$$\ln{h_i}(t) = \ln {h_0}(t) + {\beta _1}{X_1} + {\beta _2}{X_2} +  \cdot  \cdot  \cdot  + {\beta _p}{X_p}$$

+ ${h_i}(t)$是个体i在时间t时的风险值。${h_0}(t)$是所有个体在时间t时的非参数风险函数值。${\beta_p}{X_p}$是对个体i的解释变量和系数。

$${{h(t|{X_i})} \over {h(t|{X_j})}} = {{{h_0}(t)\exp (X_i^T\beta )} \over {{h_0}(t)\exp (X_j^T\beta )}} = \exp [(X_i^T - X_j^T)\beta ]$$

+ 两个分别具有协变量${X_i}$和${X_j}$的个体，其风险函数之比为相对危险度（risk ration，RR）或风险比（hazard ration，HR）

+ ${h_i}(t)$和${h_0}(t)$随时间变化。在满足比例风险假定后，不同特征样本的风险比（hazard ration，HR）不随时间变化。所以系数是固定的。无时变变量的Cox模型为宽数据(wide data)。

```{r}
coxreg <- coxph(Surv(pgtime , pgstat)~age + eet + g2 + grade + gleason + ploidy,stagec)
summary(coxreg)
coxreg

ggforest(coxreg,stagec)

#library(rms)
#dd=datadist(stagec)
#options(datadist="dd")
#f2 <- psm(Surv(time,status) ~ age+gender+grade,data =  #LIHC, dist='lognormal')
#med <- Quantile(f2) # 计算中位生存时间
#surv <- Survival(f2) # 构建生存概率函数

## 绘制COX回归中位生存时间的Nomogram图
#nom <- nomogram(f2, fun=function(x) #med(lp=x),funlabel="Median Survival Time")

#plot(nom)

#cox_fit <- survfit(coxreg)
#autoplot(cox_fit) #拟合值
##C-指数 Harrell's concordance index
#coxreg$concordance
#concordance(Surv(pgtime , pgstat) ~ predict(coxreg),stagec)
```

<!---
[生存模型的C-index（C指数）](https://blog.csdn.net/fjsd155/article/details/84669331)

[C-index/C-statistic 计算的5种不同方法及比较](https://blog.csdn.net/anshiquanshu/article/details/53438438)
--->

## [Aalen’s additive regression model](http://www.medicine.mcgill.ca/epidemiology/hanley/bios601/Encyclopedia%20of%20Biostatistics2ndEd2005.pdf)

```{r,fig.cap=' '}
aaregfit <- aareg(Surv(pgtime, pgstat)~age + eet + g2 + grade + gleason + ploidy,stagec)
aaregfit

#ggforest(aaregfit,stagec)
autoplot(aaregfit)
```

## CART树生存分析

```{r,fig.cap='CART树剪枝前'}
fit <- rpart(Surv(pgtime , pgstat)~age +
eet + g2 + grade + gleason + ploidy,stagec,method='exp')
fit
rpart.plot(fit,shadow.col = 'gray',branch = 0.4)
```

```{r,fig.cap='CART树剪枝后'}
fit2 <- prune(fit, cp = 0.017)
fit2$cptable
rpart.plot(fit2,shadow.col = 'gray',branch = 0.4)
```

```{r,fig.cap='每个结点患者的生存风险估计'}
temp <- snip.rpart(fit2,6)
km <- survfit(Surv(pgtime, pgstat) ~ temp$where, stagec)
autoplot(km)
```

```{r,fig.cap='年龄、G2阶段的瘤细胞比例、肿瘤等级grade的关系'}
ggplot(stagec)+
  geom_point(aes(age,g2,shape=factor(pgstat),
                 col=factor(pgstat)))+
  facet_wrap(~grade)
```

```{r}

```

