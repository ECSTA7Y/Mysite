---
title: "生存分析云笔记" 
author: ' '
date: '2019-05-23'
slug: survival
tags: R
categories: R
---
本文系复旦大学人口学系[张震](http://www.ssdpp.fudan.edu.cn/portal/1e2812ee711c4175a3304c7dbc7071e0/70VhqG.html)老师和华东师范大学人口研究所[李强]()老师的数据分析课程笔记。

一个R生存分析应用的介绍网页[Survival Analysis with R](https://rviews.rstudio.com/2017/09/25/survival-analysis-with-r/)

两篇重要的中文文献：

李强, 张震. (2009). 生存分析中时间变量的选择[J]. 中国人口科学(6), 88-95.

李强, 徐刚, 陈丽梅.(2019) 生存分析的应用误区[J]. 中国人口科学(01):101-112.

---

##第一讲: 基本概念

+ 社会调查只能观察到状态。人口学关心从一个状态到另一个状态转移的风险。试想每一种状态是一个格子，格子内部是人口频数。人口学能通过数频数的方式估计状态转移的风险。**在一个状态内待的时间和风险有着密切的关系**。



$T$为随机变量，上帝也不知道

生存函数：$S(t) = P(T > t)$。是存活概率也是存活百分比。

失效函数(Failure Function)：$F(t)$,$S(t) = 1 - F(t)$, $F(t)$是T的累积分布函数。



$f(t) = \frac{{dF(t)}}{{dt}}$，即$S(t)$的斜率。等价于生存时间的概率密度函数(直方图)。是无条件的风险。

风险函数: $$h(t) = \mathop {\lim }\limits_{\Delta t \to 0} \frac{{P(t \le T < t + \Delta t|T \ge t)}}{{\Delta t}},0 < h(t) <  + \infty $$



$h(t)$不是密度也不是概率。


+ censor(删截):   知道事件发生，但不知道事件何时发生。事件观测期内无法观测。
+ truncate(截平):   只有在给定观测期内的个体才会被观测到的状况。样本选择问题。生存函数对应于某种条件概率。

  + censor涉及到事件，truncate涉及到暴露量。

+ 能活到预期寿命者总是62\%

---

## 第二讲: 最大似然估计(MLE)

 Cox回归避开了模型分布假定的问题。

+ 假定数据独立同分布。

    似然函数：

$${\rm{L}}(\lambda ){\rm{ = }}\prod\limits_{i = 1}^\pi  {P(T = t)}  = \prod {f({t_i})}$$  
$\delta$是积分小区间

$$P(T = t) \approx 2\delta f(t)$$


+ 发生风险率(Occurrence-exposure rate)
$$\widehat \lambda  = \frac{1}{{\bar t }} = \frac{n}{{\sum\limits_{}^{} {{t_i}} }}$$
$\sum\limits_{}^{} {{t_i}}$是历险人年数。$n$是事件发生数。  
 $\lambda$是个概率估计。

### 删截(Censored)样本的似然函数

+ 完全样本的似然函数是在该时点t的密度函数$f({t_i})$。右删截数据是生存函数$S({C_r})$。左删截数据为累计分布函数$1 - S({C_l})$。区间删截为在该时段内的发生概率$S(L) - S(R)$。

右删截：
$$P({t_i} > 40) = S(40)$$

+ 40岁删截


$$L(\lambda ) = \prod\limits_{observed} {f({t_i})}  \cdot \prod\limits_{censored} {S(40)}$$

Assume the first $d$ individuals died, $(n-d)$ ware alive at 40:

$$\hat \lambda  = \frac{d}{{\sum {{t_i} - (n - d) \cdot 40} }}$$

分子为事件发生数。



人口学、医学中最多的情况是left-truncated & right-cencored(LT-RC)数据。

非参数模型Aalen’s additive regression model可以替代Cox模型。R的```survival```包的```aareg```函数可以进行拟合。

---

## 第三讲: 生存分析估计

R生存分析介绍：[survival analysis in R](http://www.openintro.org/stat/surv.php)



```{r pack,prompt=T, comment = NA,warning = F,message = F,fig.align='center',results = "hide"}
library(survival)
library(haven) 
library(ggplot2)
library(dplyr)
library(ggfortify)
```

+ 数据介绍：  
`los1`:时间变量  
`cen_r`:事件是否发生,被收养成功



```{r a,prompt=T, comment = NA,warning = F,message = F,fig.align='center',include = F}
cwg <- read_dta("C:/Users/xsong/Desktop/table/highdata/surv/cwg.dta")
#变量排序
cwg$event[cwg$cen_r ==0] <- 1
cwg$event[cwg$cen_r ==1] <- 0
cwg$los1 <- cwg$los1/30

cwg <- select(cwg,cen_r,event, los1,everything())
#head(cwg)#数据
```

## 生命表

``````{r life, echo=F, fig.cap=" ", out.width = '100%',fig.align='center'}
knitr::include_graphics("/img/life.jpg")
```



## Kaplan–Meier estimator | 卡普兰迈耶法

又称乘积极限法(Product-Limit Method)

$${\rm{\hat S}}(t) = \prod\limits_{{t_i} \le t} {(1 - {{\hat q}_i})}  = \prod\limits_{{t_i} \le t} {(1 - {{{d_i}} \over {{n_i}}})}$$

```{r b,prompt=T, comment = NA,warning = F,message = F,fig.align='center',out.width ='100%'}
table(cwg$event)
# Kaplan Meier Survival Curve
km <- with(cwg, Surv(los1, event == 1))
head(km,70) #删截后面有+号

km_fit <- survfit(km ~ 1, data=cwg)
km_fit #生存分析概要
summary(km_fit, times = c(0.2*(1:25))) #这个东西和生命表等价

knitr::include_graphics("/img/life2.jpg")

autoplot(km_fit) #ggplot2风格KM图

km_trt_fit <- survfit(km ~ female, data=cwg)#分性别KM估计
autoplot(km_trt_fit) #图中+号可能是"打结" ties?

```

## Cox比例风险模型

$$\ln {h_i}(t) = \ln {h_0}(t) + {\beta _1}{X_1} + {\beta _2}{X_2} +  \cdot  \cdot  \cdot  + {\beta _p}{X_p}$$







